---
title: "Bioheart Prediction Manual Gating"
author: "Elijah WIllie"
date: "2024-06-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
rm(list = ls())
gc()
suppressPackageStartupMessages({
  library(keras3)
  library(reticulate)
  use_virtualenv('r-keras', required = TRUE)
  library(tensorflow)
  library(tidyverse)
  library(FuseSOM)
  library(ggsci)
  library(uwot)
  library(data.table)
  library(SingleCellExperiment)
  library(caret)
  library(ROCR)
  library(psych)
  library(tensorflow)
  library(glmnet)
  library(data.tree)
  library(ggtree)
  library(ape)
  library(grpregOverlap)
  library(ggiraph)
  library(scales)
  library(ggnewscale)
})
source('~/Documents/PhD/bioheart_analysis/scripts/helperFuncs.R')
# source('~/Documents/PhD/bioheart_analysis/scripts/vae_model.R')
source('~/Documents/PhD/bioheart_analysis/scripts/vae_class_model.R')
# source('~/Documents/PhD/bioheart_analysis/scripts/wae_model.R')
source('~/Documents/PhD/bioheart_analysis/scripts/customCV.R')
set_random_seed(1994)
```

# load both studies
```{r}
nCores <- 4
BPPARAM <- simpleSeg:::generateBPParam(nCores)
theme_set(theme_classic())
```

# Set the markers
```{r}
useMarkers <- c('HLA_DR', 'CD3', 'CD4', 'CD8a', 'CD25', 'CD127', 'FoxP3', 'CD27',
                'KLRG1', 'CD56', 'CD45RO', 'CD45RA', 'CD192_CCR2', 'CD194_CCR4',
                'CD196_CCR6',
                'CD39', 'CD38', 'Ki67', 'CD183_CXCR3', 'CCR7', 'CD19', 'CD20',
                'IgD', 'CD14', 'CD304', 'CD141', 'CD1c_PE')

allMarkers <- c('HLA_DR', 'CD3', 'CD4', 'CD8a', 'CD25', 'CD127', 'FoxP3', 'CD27',
                'KLRG1', 'CD56', 'CD45RO', 'CD45RA', 'CD192_CCR2', 'CD194_CCR4',
                'CD196_CCR6',
                'CD39', 'CD38', 'Ki67', 'CD183_CXCR3', 'CCR7', 'CD19', 'CD20',
                'IgD', 'CD14', 'CD304', 'CD141', 'CD1c_PE', "CD11b", "CD253_TRAIL",
                "CD34", "CD61", "CD11c", "eNOS", "LOX_1", "CD86", "CD16", "CD45_106",
                "CD45_108", "P2X7", "NOX5")
```

# Load normalised data
```{r, eval=FALSE}
load('../sce_dat/study_4_autoEncoder_sce.RData')
load('../sce_dat/study_3_autoEncoder_sce.RData')
```

# Read in the dataset
## Study 4
```{r, eval=T}
# study 4
set.seed(1994)
df <- fread('../raw_data/bioheart_ct_cytof_data_b4_mg.csv',
              nThread = 7) %>%
  as.data.frame()

df_asinh <- df
# df_asinh <- df[rowsum_df != 0, ]
```

```{r, eval=FALSE}
df$mg_cell_type_distinct <- dplyr::recode(df$mg_cell_type_distinct,
                             "CD141+ DCs" = "DCs",
                            "CD1c+ DCs" = "DCs",
                            
                             )
```

# asinh norm
```{r, eval=T}
df_asinh[, useMarkers] <- cyCombine::transform_asinh(df_asinh[, useMarkers], markers = useMarkers)

preProcValues <- preProcess(df_asinh[, useMarkers], method = c("range"))
#
df_asinh[, useMarkers] <- predict(preProcValues, df_asinh[, useMarkers])
```


## Study 3
```{r, eval=T}
set.seed(1994)
df_3 <- fread('../Study_3_2019/all_batches_processed_mg_10K.csv',
              nThread = 7) %>% 
  as.data.frame()

# %>%
#   group_by(sample_id)
df_3[, useMarkers] <- cyCombine::transform_asinh(df_3[, useMarkers], markers = useMarkers)
df_3[, useMarkers] <- predict(preProcValues, df_3[, useMarkers])
```

# Get the reference sample for training
```{r, eval=T}
res_ind <- ComputeReferenceSample(df_asinh, useMarkers, N = 2)
```


# Get the encoding dimensions and the number of clusters 
```{r}
set.seed(1994)
train_dat <- df_asinh[which(df_asinh$sample_id %in% res_ind$topNSamples), ]
encoding_dim <- FuseSOM::computeGridSize(train_dat[, useMarkers])
```

# Define autoencoder model
```{r}
batch_size = 32L
vae_model <- train_vae_class_model(train_dat = train_dat[, useMarkers], batch_size = batch_size,
                             useMarkers = useMarkers, epochs = 100)
```

# Predict on study 4
```{r}
train_decoded <- decode_samples(new_samples = as.matrix(df_asinh[, useMarkers]), 
                                vae = vae_model$vae, batch_size = batch_size)
df_norm <- train_decoded[[1]]


colnames(df_norm) <- useMarkers
```

# Predict on study 3
```{r, eval=T}
test_decoded <- decode_samples(new_samples = as.matrix(df_3[, useMarkers]), 
                               vae = vae_model$vae,batch_size = batch_size)
df_3_norm <- test_decoded[[1]]

df_3_encoded <- test_decoded$encoded %>%
  as.matrix() %>%
  as.data.frame()

colnames(df_3_norm) <- useMarkers
```

# Create SCE object for study 4 and cluster it
```{r}
sce_norm <- SingleCellExperiment(assays = list(norm = t(df_norm[, useMarkers]),
                                               raw = t(df_asinh[, useMarkers])
),
colData = df_asinh %>% dplyr::select(-useMarkers))
reducedDims(sce_norm) <- list(VAE= train_decoded$encoded %>%
                                as.matrix() %>%
                                as.data.frame())
```

# Generate SCE object for study 3
```{r}
sce_3_norm <- SingleCellExperiment(assays = list(norm = t(df_3_norm[, useMarkers]),
                                               raw = t(df_3[, useMarkers])
),
colData = df_3 %>% dplyr::select(-useMarkers))
reducedDims(sce_3_norm) <- list(VAE=test_decoded$encoded %>%
                                as.matrix() %>%
                                as.data.frame())


```

# Train clustering model with scCLassify
## Select training data 
```{r}
x_train <- assay(sce_norm, "norm") %>%
  t() %>%
  as.data.frame() %>%
  mutate(cellTypes = sce_norm$mg_cell_type_distinct)
  # mutate(sample_id = sce_norm$sample_id) %>%
  # group_by(clusters) %>%
  # dplyr::filter(sample_id %in% res_ind$topNSamples) %>%
  # slice_sample(n = 2000) %>%
  # dplyr::select(-sample_id)

```



```{r}
x_test <- assay(sce_3_norm, "norm") %>%
  t() %>%
  as.data.frame()
```


```{r,eval=FALSE}
cols_to_remove <- findCorrelation(R1, cutoff = .6, exact = FALSE)
if(length(cols_to_remove) > 0) {
  x_train <- x_train[, -cols_to_remove]
x_test <- x_test[, -cols_to_remove]
}
```


```{r, eval=T}
df_3_clusters <- cellTypeClassifier(train_x = x_train, test_x = x_test, model = 'lda')
```

```{r}
sce_3_norm$mg_clusters <- df_3_clusters
```


# Setup Clinical information
## Study 4
```{r}
clinicaldata <- colData(sce_norm) %>%
  as.data.frame() %>%
  dplyr::select(sample_id, Gensini, Gender, Age) %>%
  distinct()
clinicaldata$Gensini_bin <- factor(if_else(clinicaldata$Gensini > 0, 1, 0))

encoded_gender <- model.matrix(~Gender-1, data=clinicaldata)
clinicaldata <- cbind(clinicaldata, encoded_gender)

# row_names <- rownames(data)

# Age <- clinicaldata[match(row_names,clinicaldata$sample_id),
#                                       "Age"]
# GenderM <- clinicaldata[match(row_names,clinicaldata$sample_id),
#                                       c("GenderM")]

# clinicaldata_info <- cbind(Age, GenderM)
```

## Study 3
```{r}
clinicaldata_3 <- colData(sce_3_norm) %>%
  as.data.frame() %>%
  dplyr::select(sample_id, Gensini_bin, Gender, Age) %>%
  distinct()
# clinicaldata_3$Gensini_bin <- factor(if_else(clinicaldata_3$Gensini > 0, 1, 0))
encoded_gender_3 <- model.matrix(~Gender-1, data=clinicaldata_3)
clinicaldata_3 <- cbind(clinicaldata_3, encoded_gender_3)
clinicaldata_3$Gensini_bin <- as.factor(clinicaldata_3$Gensini_bin)
# row_names_3 <- rownames(data_3)

# Age_3 <- clinicaldata_3[match(row_names_3,clinicaldata_3$sample_id),
#                                       "Age"]
# GenderM_3 <- clinicaldata_3[match(row_names_3,clinicaldata_3$sample_id),
#                                       c("GenderM")]
# 
# clinicaldata_info_3 <- cbind(Age, GenderM)
```


# Compute training features
## Proportions
```{r}
sce_norm <- sce_norm[, sce_norm$mg_cell_type_distinct != "other"]
sce_norm <- sce_norm[, sce_norm$mg_cell_type_distinct != ""]
# sce_norm$mg_cell_type_distinct <- droplevels(sce_norm$mg_cell_type_distinct)
data_logit <- computeFeatures(sce = sce_norm, featureType = 'prop', 
                              cellTypeCol = 'mg_cell_type_distinct', 
                              sampleCol = 'sample_id', 
                              logit = T, useMarkers = useMarkers)
row_names <- rownames(data_logit)
condition <- factor(clinicaldata[match(row_names,clinicaldata$sample_id),
                                      "Gensini_bin"])
```

## Means
```{r, eval=T}
markerMeanCellType <- computeFeatures(sce = sce_norm, featureType = 'mean', 
                              cellTypeCol = 'mg_cell_type_distinct', sampleCol = 'sample_id', 
                              logit = T, useMarkers = useMarkers)
```


## Compute features on study 3

## Proportions
```{r}
sce_3_norm <- sce_3_norm[, sce_3_norm$mg_clusters != "other"]
sce_3_norm <- sce_3_norm[, sce_3_norm$mg_clusters != ""]
sce_3_norm$mg_clusters <- droplevels(sce_3_norm$mg_clusters)

data_3_logit <- computeFeatures(sce = sce_3_norm, featureType = 'prop', 
                              cellTypeCol = 'mg_clusters', sampleCol = 'sample_id', 
                              logit = T, useMarkers = useMarkers)

row_names_3 <- rownames(data_3_logit)
condition_3 <- factor(clinicaldata_3[match(row_names_3,clinicaldata_3$sample_id),
                                      "Gensini_bin"])
```

## Means
```{r, eval=T}
markerMeanCellType_3 <- computeFeatures(sce = sce_3_norm, featureType = 'mean', 
                              cellTypeCol = 'mg_clusters', sampleCol = 'sample_id', 
                              logit = T, useMarkers = useMarkers)
```

# Generate Tree
```{r, eval=T}
root <- Node$new("Root")
  myeloid <- root$AddChild('Myeloid_logit')
    `14+ monos` <- myeloid$AddChild('14+ monos_logit')
    `16+ monos` <- myeloid$AddChild('16+ monos_logit') 
    pDCs <- myeloid$AddChild('pDCs_logit')
    `CD141+ DCs` <- myeloid$AddChild('CD141+ DCs_logit')
    `CD1c+ DCs` <- myeloid$AddChild('CD1c+ DCs_logit')
  NK <- root$AddChild('NK_logit')
  `B cells` <- root$AddChild('B cells_logit')
  CD3 <- root$AddChild('CD3_logit')
    CD8hi <- CD3$AddChild('CD8hi_logit')
    CD8lo <- CD3$AddChild('CD8lo_logit')
    CD4 <- CD3$AddChild('CD4_logit')
      `CD4+ Tconv` <- CD4$AddChild('CD4+ Tconv_logit')
      `CD4+ Treg` <- CD4$AddChild('CD4+ Treg_logit')
  # other <- root$AddChild('other_logit')
```

# Generate grouping structures
```{r}
nclust <- ncol(data_logit)
tree <- treekoR:::findChildren(ggtree(as.phylo(root),
                                            ladderize = F, layout = 'dendrogram'))

groups <- generateGroups(tree = tree, nclust = nclust, 
                         proportions = data_logit, means = markerMeanCellType)
```

# Add the clinical data in
```{r, eval=FALSE}
var_groups[[length(var_groups) + 1]] <- 309:310
```

# Process training and testing data
## Training
```{r}
# Combine all input data matrices
X_train <- cbind(data_logit, markerMeanCellType) 
  
  # Scale the combined data
scaleVals <- preProcess(X_train, method = c('range'))
X_train <- predict(scaleVals, X_train) %>%
    as.matrix()
# X_train[, 1:nclust] <- X_train[, 1:nclust]/nclust
# X_train[, (nclust+1):ncol(markerMeanCellType)] <- X_train[, (nclust+1):ncol(markerMeanCellType)]/(nclust*length(markerMeanCellType))
  
  # Extract response variable
y_train <- condition %>%
    as.numeric()
```

## Testing
```{r}
X_test_study_3 <- cbind(data_3_logit, markerMeanCellType_3) %>%
  as.matrix()
# colnames(X_test_study_3) <- janitor::make_clean_names(colnames(X_test_study_3))
X_test_study_3 <- predict(scaleVals, X_test_study_3)
# X_test_study_3[, 1:nclust] <- X_test_study_3[, 1:nclust]/nclust
# X_test_study_3[, (nclust+1):ncol(markerMeanCellType)] <- X_test_study_3[, (nclust+1):ncol(markerMeanCellType)]/(nclust*length(markerMeanCellType))
```


## Fit Overlap model
```{r}
fit <- fitModel(x_train = X_train, y_train = y_train, groups = groups, penalty = 'cMCP')
```


## Predict on test data
```{r}
test_auc <- plotAUC(fit = fit, x_test = X_test_study_3, y_test = condition_3, title = "Study 3 MG - All AUC =")
test_auc$plot

# write.csv(test_auc$preds,
#           '../auc_data/fs_glasso_auc_all_study_3.csv')

```

# Visualise Resulting Tree
```{r, fig.height=10, fig.width=16}
visualiseModelTree(fit = fit, tree = tree, type = "MG", training_data = X_train)
```



## Look at heatmap
```{r, fig.height=6, fig.width=8,eval=T}
scater::plotGroupedHeatmap(sce_norm, 
                           features = useMarkers, 
                           group = "mg_cell_type_distinct", 
                           block = "mg_cell_type_distinct",
                           exprs_values = "norm",
                           center = TRUE, 
                           scale = TRUE, 
                           zlim = c(-2,2),
                           cluster_rows = FALSE)
```

# Fit a baseline Lasso model
```{r}
set.seed(999)
cv.lasso <- cv.glmnet(X_train, condition, family='binomial', alpha=1, parallel=TRUE, 
                      standardize=F, relax = F, type.measure = 'auc',nfolds = 10)
plot(cv.lasso)
coef(cv.lasso, s='lambda.min')
coef <- coef(cv.lasso, s='lambda.min')
selected_attributes <- (coef@i[-1]+1)

```

```{r}
pred_test <- predict(cv.lasso, newx = X_test_study_3, 
                     type = "response", s = 'lambda.min')

write.csv(as.data.frame(pred_test),
          '../auc_data/mg_model_baseline_auc_study_3.csv')


pred_fs <- prediction(pred_test, condition_3)
perf_fs <- ROCR::performance(pred_fs, "tpr", "fpr")


plt_dat = data.frame(
  FPR = perf_fs@x.values[[1]],
  TPR = perf_fs@y.values[[1]]
)

auc_perf <- ROCR::performance(pred_fs, measure = "auc")
auc <- auc_perf@y.values[[1]]

# generate AUC plot
p_auc <- ggplot(plt_dat, aes(x = FPR, y = TPR)) +
  geom_line(colour = "blue") +
  labs(x = perf_fs@x.name, y = perf_fs@y.name) +
  geom_abline(slope = 1, intercept = 0) + theme_bw() +
  theme(
    plot.title = element_text(color="Black", size=16, face="bold", hjust = 0.5),
    plot.subtitle = element_text(color = "red", size = 16, hjust = 0.5),
    axis.title.x = element_text(color="Black", size=16),
    axis.title.y = element_text(color="Black", size=16),
    axis.text.y = element_text(size = 16),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 16),
    strip.text.x = element_text(size = 16),
    legend.title = element_text(size=16), #change legend title font size
    legend.text = element_text(size=16) #change legend text font size)
  )  + ggtitle(paste("Test Set - AUC =", round(auc, 2)))

p_auc
```

# Save SCE objects
```{r, eval=F}
save(sce_norm, file = "../sce_dat/study_4_MG_MMD_VAE_sce.RData")
save(sce_3_norm, file = "../sce_dat/study_3_MG_MMD_VAE_sce.RData")
```


# Look at PCA plots
## Study 4 - Normalised
```{r}
set.seed(1994)
df_encoded_sub <- assay(sce_norm, "norm") %>% 
  t() %>%
  as.data.frame() %>%
  mutate(clusters = sce_norm$mg_cell_type_distinct) %>%
  slice_sample(n = 50000)

# umap_dat <- umap(df_encoded_sub, n_neighbors = 30, verbose = TRUE, n_threads = 7,
#                  seed = 1994, init = 'random', scale = "none") %>%
#   as.data.frame()

res.pca <- prcomp(df_encoded_sub[, useMarkers], scale = T, center = T)
```

```{r, fig.height=6, fig.width=8}
res.ind <- get_pca_ind(res.pca)
res.ind$coord %>%
  as.data.frame()  %>%
  dplyr::select(c('Dim.1', 'Dim.2',)) %>%
  mutate(clusters = df_encoded_sub$clusters) %>%
  ggplot(aes(Dim.1, Dim.2)) +
  geom_point(aes(colour = clusters))
  
# res.ind$contrib        # Contributions to the PCs
# res.ind$cos2           # Quality of representation 
```


## Study 4 - Unnormalised
```{r}
set.seed(1994)
df_unnorm <- assay(sce_norm, "raw") %>% 
  t() %>%
  as.data.frame() %>%
  mutate(clusters = sce_norm$mg_cell_type_distinct) %>%
  slice_sample(n = 50000)

# umap_dat <- umap(df_encoded_sub, n_neighbors = 30, verbose = TRUE, n_threads = 7,
#                  seed = 1994, init = 'random', scale = "none") %>%
#   as.data.frame()

res.pca.unnorm <- prcomp(df_unnorm[, useMarkers], scale = TRUE, center = TRUE)
```

```{r, fig.height=6, fig.width=8}
res.ind.unnorm <- get_pca_ind(res.pca.unnorm)
res.ind.unnorm$coord %>%
  as.data.frame()  %>%
   dplyr::select(c('Dim.1', 'Dim.2',)) %>%
  mutate(clusters = df_unnorm$clusters) %>%
  ggplot(aes(Dim.1, Dim.2)) +
  geom_point(aes(colour = clusters))
  
# res.ind$contrib        # Contributions to the PCs
# res.ind$cos2           # Quality of representation 
```

## Combine them and plot the unnorm version in grey
```{r}
rbind(res.ind$coord[, 1:2], res.ind.unnorm$coord[, 1:2]) %>%
  as.data.frame() %>%
  mutate(Norm = rep(c("Yes", "No"), times = c(50000, 50000))) %>%
  ggplot(aes(Dim.1, Dim.2)) +
  geom_point(aes(colour = Norm))
```


## Study 3 - Normalised
```{r}
set.seed(1994)
df_3_norm_sub <- assay(sce_3_norm, "norm") %>% 
  t()
  as.data.frame() %>%
  mutate(clusters = sce_3_norm$mg_clusters) %>%
  slice_sample(n = 50000)

# umap_dat <- umap(df_encoded_sub, n_neighbors = 30, verbose = TRUE, n_threads = 7,
#                  seed = 1994, init = 'random', scale = "none") %>%
#   as.data.frame()

res.pca.3.norm <- prcomp(df_3_norm_sub[, 1:16], scale = TRUE, center = TRUE)
```

```{r, fig.height=6, fig.width=8}
res.ind.3.norm <- get_pca_ind(res.pca.3.norm)
res.ind.3.norm$coord %>%
  as.data.frame()  %>%
  dplyr::select(c('Dim.1', 'Dim.2',)) %>%
  mutate(clusters = df_3_norm_sub$clusters) %>%
  ggplot(aes(Dim.1, Dim.2)) +
  geom_point(aes(colour = clusters))
  
# res.ind$contrib        # Contributions to the PCs
# res.ind$cos2           # Quality of representation 
```

## Study 3 - Unnormalised
```{r}
set.seed(1994)
df_3_unnorm_sub <- assay(sce_3_norm, "raw") %>% 
  t() %>%
  as.data.frame() %>%
  mutate(clusters = sce_3_norm$mg_clusters) %>%
  slice_sample(n = 50000)

# umap_dat <- umap(df_encoded_sub, n_neighbors = 30, verbose = TRUE, n_threads = 7,
#                  seed = 1994, init = 'random', scale = "none") %>%
#   as.data.frame()

res.pca.3.unnorm <- prcomp(df_3_unnorm_sub[, useMarkers], scale = TRUE, center = TRUE)
```

```{r, fig.height=6, fig.width=8}
res.ind.3.unnorm <- get_pca_ind(res.pca.3.unnorm)
res.ind.3.unnorm$coord %>%
  as.data.frame()  %>%
   dplyr::select(c('Dim.1', 'Dim.2',)) %>%
  mutate(clusters = df_3_unnorm_sub$clusters) %>%
  ggplot(aes(Dim.1, Dim.2)) +
  geom_point(aes(colour = clusters))
  
# res.ind$contrib        # Contributions to the PCs
# res.ind$cos2           # Quality of representation 
```

## Combine them and plot the unnorm version in grey
```{r}
rbind(res.ind.3.norm$coord[, 1:2], res.ind.3.unnorm$coord[, 1:2]) %>%
  as.data.frame() %>%
  mutate(Norm = rep(c("Yes", "No"), times = c(50000, 50000))) %>%
  ggplot(aes(Dim.1, Dim.2)) +
  geom_point(aes(colour = Norm))
```

# Look at significant features
## Study 4
```{r, eval=T}
# CCR2 (OR 1.12), CCR4 (OR 1.08), CD38 and CD45RO (OR 1.13), HLA-DR (OR 1.06), and Ki67 (1.22)
stats_mean <- getSigFeatures(fit, type = 'mean',  
                         mean = markerMeanCellType, clinicaldata = clinicaldata, 
                         outcome = "Gensini_bin")

p.mean <- plotSigFeatures(stats = stats_mean$stats, sigFeatures = stats_mean$sig_features, outcome = "Gensini bin")
```
```{r}
# CCR2 (OR 1.12), CCR4 (OR 1.08), CD38 and CD45RO (OR 1.13), HLA-DR (OR 1.06), and Ki67 (1.22)
stats_prop <- getSigFeatures(fit, type = 'prop', prop = data_logit, 
                              clinicaldata = clinicaldata, 
                         outcome = "Gensini_bin")
p.prop <- plotSigFeatures(stats = stats_prop$stats, sigFeatures = stats_prop$sig_features, outcome = "Gensini bin")
```
## Study 3
```{r, eval=T}
# CCR2 (OR 1.12), CCR4 (OR 1.08), CD38 and CD45RO (OR 1.13), HLA-DR (OR 1.06), and Ki67 (1.22)
stats_mean_3 <- getSigFeatures(fit, type = 'mean',  
                         mean = markerMeanCellType_3, clinicaldata = clinicaldata_3, 
                         outcome = "Gensini_bin")

p.mean_3 <- plotSigFeatures(stats = stats_mean_3$stats, sigFeatures = stats_mean_3$sig_features, 
                            outcome = "Gensini bin")
```
```{r, eval=FALSE}
# CCR2 (OR 1.12), CCR4 (OR 1.08), CD38 and CD45RO (OR 1.13), HLA-DR (OR 1.06), and Ki67 (1.22)
stats_prop_3 <- getSigFeatures(fit, type = 'prop',  
                         prop = data_3_logit, clinicaldata = clinicaldata_3, 
                         outcome = "Gensini_bin")

p.prop_3 <- plotSigFeatures(stats = stats_prop_3$stats, sigFeatures = stats_prop_3$sig_features, 
                            outcome = "Gensini bin")
```