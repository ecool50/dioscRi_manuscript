---
title: "BioHEART-CT Normalisation Analysis Combined"
author: "Elijah WIllie"
date: "2024-08-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
rm(list = ls())
gc()
suppressPackageStartupMessages({
  library(keras3)
  library(reticulate)
  use_virtualenv('r-keras', required = TRUE)
  library(tensorflow)
  library(tidyverse)
  library(FuseSOM)
  library(ggsci)
  library(uwot)
  library(data.table)
  library(SingleCellExperiment)
  library(caret)
  library(ROCR)
  library(psych)
  library(tensorflow)
  library(glmnet)
  library(data.tree)
  library(ggtree)
  library(ape)
  library(grpregOverlap)
  library(ggiraph)
  library(scales)
  library(ggnewscale)
  library(rstatix)
  library(ggpubr)
})
source('~/Documents/PhD/bioheart_analysis/scripts/helperFuncs.R')
source('~/Documents/PhD/bioheart_analysis/scripts/wae_model.R')
source('~/Documents/PhD/bioheart_analysis/scripts/customCV.R')
source('~/Documents/PhD/bioheart_analysis/scripts/estimate.ED.R')
source('~/Documents/PhD/bioheart_analysis/scripts/deep_learning_helper_funcs.R')
set_random_seed(1994)
```

# load both studies
```{r}
nCores <- 4
BPPARAM <- simpleSeg:::generateBPParam(nCores)
theme_set(theme_classic())
```

# Set the markers
```{r}
useMarkers <- c('HLA_DR', 'CD3', 'CD4', 'CD8a', 'CD25', 'CD127', 'FoxP3', 'CD27',
                'KLRG1', 'CD56', 'CD45RO', 'CD45RA', 'CD192_CCR2', 'CD194_CCR4',
                'CD196_CCR6',
                'CD39', 'CD38', 'Ki67', 'CD183_CXCR3', 'CCR7', 'CD19', 'CD20',
                'IgD', 'CD14', 'CD304', 'CD141', 'CD1c_PE')

allMarkers <- c('HLA_DR', 'CD3', 'CD4', 'CD8a', 'CD25', 'CD127', 'FoxP3', 'CD27',
                'KLRG1', 'CD56', 'CD45RO', 'CD45RA', 'CD192_CCR2', 'CD194_CCR4',
                'CD196_CCR6',
                'CD39', 'CD38', 'Ki67', 'CD183_CXCR3', 'CCR7', 'CD19', 'CD20',
                'IgD', 'CD14', 'CD304', 'CD141', 'CD1c_PE', "CD11b", "CD253_TRAIL",
                "CD34", "CD61", "CD11c", "eNOS", "LOX_1", "CD86", "CD16", "CD45_106",
                "CD45_108", "P2X7", "NOX5")
```


# Define cell types of interest
```{r}
final_celltypes <- c(
   "B cells",
   "CD8hi",
   "14+ monos",
   "CD4+ Tconv",
   "CD8lo",
   "NK",
   "16+ monos",
   "CD4+ Treg",
   "pDCs",
   "CD141+ DCs"
    )
```


# Read in the datasets
## Study 4
```{r}
# study 4
set.seed(1994)
df <- fread('../raw_data/bioheart_ct_cytof_data_b4_mg.csv',
              nThread = 7) %>%
  as.data.frame() 

colnames(df)[colnames(df) == "CyTOF.Batch"] = "batch_old"
df <- df[which(df$mg_cell_type_distinct %in% final_celltypes), ]

df$Batch <- if_else(df$batch_old %like% 4, 4, 3)
df[, useMarkers] <- cyCombine::transform_asinh(df[, useMarkers], 
                                               markers = useMarkers)

preProcValues <- preProcess(df[, useMarkers], method = c("range"))
df[, useMarkers] <- predict(preProcValues, df[, useMarkers])
```


## Study 3
```{r}
df_3 <- fread('../Study_3_2019/all_batches_processed_mg_10K.csv',
              nThread = 7) %>% 
  as.data.frame()
colnames(df_3)[colnames(df_3) == "Batch"] = "batch_old"
colnames(df_3)[colnames(df_3) == "Gensini_bin"] = "gensini_bin"
df_3 <- df_3[which(df_3$CellTypes %in% final_celltypes), ]

df_3$batch <- if_else(df_3$batch_old %like% 4, 4, 3)

df_3[, useMarkers] <- cyCombine::transform_asinh(df_3[, useMarkers], 
                                                 markers = useMarkers)

df_3[, useMarkers] <- predict(preProcValues, df_3[, useMarkers])
```

# Train on study 4
# Get the reference sample for training
```{r}
res_ind <- ComputeReferenceSample(df, useMarkers, N = 2)
```


# Get the encoding dimensions and the number of clusters 
```{r}
set.seed(1994)
train_dat <- df[which(df$sample_id %in% res_ind$topNSamples), ]
encoding_dim <- FuseSOM::computeGridSize(train_dat[, useMarkers])
```

# Define autoencoder model
```{r}
batch_size = 32L
vae_model <- train_wae_mmd_model(train_dat = train_dat[, useMarkers], batch_size = batch_size, 
                             useMarkers = useMarkers, epochs = 300)
```

  
```{r}
train_decoded <- decode_samples_wae(new_samples = as.matrix(df[, useMarkers]), 
                                vae = vae_model$vae)
df_norm <- train_decoded[[1]]

colnames(df_norm) <- useMarkers
```

# Predict on study 3
```{r, eval=T}
test_decoded <- decode_samples_wae(new_samples = as.matrix(df_3[, useMarkers]), 
                               vae = vae_model$vae)
df_3_norm <- test_decoded[[1]]

colnames(df_3_norm) <- useMarkers
```

```{r}
revPredict <- function(preproc, data,digits=0,range = F) {
   if (range == T){
     data<-data %>%
       select(one_of(dimnames(preproc$ranges)[[2]])) %>%
       map2_df(preproc$ranges[2,]-preproc$ranges[1,], ., function(min_max, dat) min_max* dat)  %>%
       map2_df(preproc$ranges[1,], ., function(min, dat) min + dat) %>%
      mutate_if(is.numeric,funs(round(.,digits = digits)))
    return(data)
    }
  data<- data %>%
    select(one_of(names(preproc$mean))) %>%
    map2_df(preproc$std, ., function(sig, dat) dat * sig)  %>%
    map2_df(preproc$mean, ., function(mu, dat) dat + mu) %>%
    mutate_if(is.numeric,funs(round(.,digits = digits)))
  return(data)
}
```

```{r}
df_raw <- df %>%
  dplyr::select(c(useMarkers, sample_id)) %>%
  dplyr::mutate(Gensini = df$gensini_bin) %>%
  dplyr::mutate(Batch = df$batch_old)

df_norm <- df_norm %>%
  dplyr::mutate(sample_id = df$sample_id) %>%
  dplyr::mutate(Gensini = df$gensini_bin) %>%
  dplyr::mutate(Batch = df$batch_old)

df_3_raw <- df_3 %>%
  dplyr::select(c(useMarkers, sample_id)) %>%
  dplyr::mutate(Gensini = df_3$gensini_bin) %>%
  dplyr::mutate(Batch = df_3$batch_old)

df_3_norm <- df_3_norm %>%
  dplyr::mutate(sample_id = df_3$sample_id) %>%
  dplyr::mutate(Gensini = df_3$gensini_bin) %>%
  dplyr::mutate(Batch = df_3$batch_old)

df_raw_combined <- rbind(df_raw, df_3_raw)
df_norm_combined <- rbind(df_norm, df_3_norm)

# df_raw_combined[, useMarkers] <- revPredict(preProcValues, 
#                                             data = df_raw_combined[, useMarkers], digits = 8, range = T)
# 
# df_norm_combined[, useMarkers] <- revPredict(preProcValues, 
#                                             data = df_norm_combined[, useMarkers], digits = 8, range = T)

markers <- c('CD4', 'CD20', 'CD3', 'CD8a')
```

## Density per sample
### Before Normalisation
```{r}
p.den.raw.combined <- df_raw_combined %>%
  dplyr::select(c(markers, sample_id, Gensini, Batch)) %>%
  melt(id.var = c('sample_id', 'Gensini', 'Batch')) %>%
  dplyr::mutate(sample_id = as.factor(sample_id)) %>%
  dplyr::mutate(Batch = as.factor(Batch)) %>%
  ggplot(aes(x = value, color = sample_id)) +
  # gghighlight(Batch %like% '3') + 
  geom_density(alpha = 0.5) +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  # scale_color_aaas() +
  theme(legend.position = 'none') +
  labs(title = "Density Plots of Raw Marker Intensities Combined", x = "Intensity", y = "Density")
```

### After Normalisation
```{r}
p.den.norm.combined <- df_norm_combined %>%
  dplyr::select(c(markers, sample_id, Gensini, Batch)) %>%
  melt(id.var = c('sample_id', 'Gensini', 'Batch')) %>%
  dplyr::mutate(sample_id = as.factor(sample_id)) %>%
   dplyr::mutate(Batch = as.factor(Batch)) %>%
  ggplot(aes(x = value, color = sample_id)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  theme(legend.position = 'none') +
  labs(title = "Density Plots of Normalised Marker Intensities Combined", x = "Intensity", y = "Density")
```
## Density per Batch
### Before Normalisation
```{r}
p.den.raw.combined <- df_raw_combined %>%
  dplyr::select(c(markers, sample_id, Gensini, Batch)) %>%
  melt(id.var = c('sample_id', 'Gensini', 'Batch')) %>%
  dplyr::mutate(sample_id = as.factor(sample_id)) %>%
  dplyr::mutate(Batch = as.factor(Batch)) %>%
  ggplot(aes(x = value, color = Batch)) +
  # gghighlight(Batch %like% '3') + 
  geom_density(alpha = 0.5) +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  # scale_color_aaas() +
  theme(legend.position = 'none') +
  labs(title = "Density Plots of Raw Marker Intensities Combined", x = "Intensity", y = "Density")
```

### After Normalisation
```{r}
p.den.norm.combined <- df_norm_combined %>%
  dplyr::select(c(markers, sample_id, Gensini, Batch)) %>%
  melt(id.var = c('sample_id', 'Gensini', 'Batch')) %>%
  dplyr::mutate(sample_id = as.factor(sample_id)) %>%
   dplyr::mutate(Batch = as.factor(Batch)) %>%
  ggplot(aes(x = value, color = Batch)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  # theme(legend.position = 'none') +
  labs(title = "Density Plots of Normalised Marker Intensities Combined", x = "Intensity", y = "Density")
```
