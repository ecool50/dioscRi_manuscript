---
title: "Deep Learning all batches"
author: "Elijah WIllie"
date: "2024-03-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = TRUE) 
knitr::opts_chunk$set(fig.width=10, fig.height=6) 
```

```{r}
rm(list = ls())
gc()
suppressPackageStartupMessages({
  library(keras3)
  library(reticulate)
  use_virtualenv('r-keras', required = TRUE)
  library(tensorflow)
  library(tidyverse)
  library(FuseSOM)
  library(ggsci)
  library(uwot)
  library(data.table)
  library(SingleCellExperiment)
  library(caret)
  library(ROCR)
  library(psych)
  library(tensorflow)
  library(glmnet)
  library(data.tree)
  library(ggtree)
  library(ape)
  library(grpregOverlap)
  library(ggiraph)
  library(scales)
  library(ggnewscale)
})
source('~/Documents/PhD/bioheart_analysis/scripts/helperFuncs.R')
source('~/Documents/PhD/bioheart_analysis/scripts/vae_model.R')
source('~/Documents/PhD/bioheart_analysis/scripts/deep_learning_helper_funcs.R')
set_random_seed(1994)
```

# load both studies
```{r}
nCores <- 4
BPPARAM <- simpleSeg:::generateBPParam(nCores)
theme_set(theme_classic())
```

# Set the markers
```{r}
useMarkers <- c('HLA_DR', 'CD3', 'CD4', 'CD8a', 'CD25', 'CD127', 'FoxP3', 'CD27',
                'KLRG1', 'CD56', 'CD45RO', 'CD45RA', 'CD192_CCR2', 'CD194_CCR4',
                'CD196_CCR6',
                'CD39', 'CD38', 'Ki67', 'CD183_CXCR3', 'CCR7', 'CD19', 'CD20',
                'IgD', 'CD14', 'CD304', 'CD141', 'CD1c_PE')

allMarkers <- c('HLA_DR', 'CD3', 'CD4', 'CD8a', 'CD25', 'CD127', 'FoxP3', 'CD27',
                'KLRG1', 'CD56', 'CD45RO', 'CD45RA', 'CD192_CCR2', 'CD194_CCR4',
                'CD196_CCR6',
                'CD39', 'CD38', 'Ki67', 'CD183_CXCR3', 'CCR7', 'CD19', 'CD20',
                'IgD', 'CD14', 'CD304', 'CD141', 'CD1c_PE', "CD11b", "CD253_TRAIL",
                "CD34", "CD61", "CD11c", "eNOS", "LOX_1", "CD86", "CD16", "CD45_106",
                "CD45_108", "P2X7", "NOX5")
```

# Define cell types of interest
```{r}
final_celltypes <- c(
   "B cells",
   "CD8hi",
   "14+ monos",
   "CD4+ Tconv",
   "CD8lo",
   "NK",
   "16+ monos",
   "CD4+ Treg",
   "pDCs",
   "CD141+ DCs"
    )
```

# Update the markers
```{r}
useMarkers <- gsub("_", "-", useMarkers)
allMarkers <- gsub("_", "-", allMarkers)
```

# Load normalised data
```{r}
load('../sce_dat/study_4_MMD_VAE_sce.RData')
load('../sce_dat/study_3_MMD_VAE_sce.RData')
```

# Train cell type identification model
## Set up training and testing data
```{r}
x_train <- assay(sce_norm, "norm") %>%
  t() %>%
  as.data.frame() %>%
   # mutate(sample_id = sce_norm$sample_id) %>%
  mutate(cellTypes = factor(sce_norm$mg_cell_type_distinct)) %>%
  dplyr::filter(cellTypes %in% final_celltypes) %>%
  # dplyr::filter(sample_id %in% res_ind$topNSamples) %>%
  # dplyr::select(-sample_id) %>%
  mutate(cellTypes = droplevels(cellTypes))

x_test <- assay(sce_3_norm, "norm") %>%
  t() %>%
  as.data.frame() %>%
  mutate(cellTypes = factor(sce_3_norm$CellTypes)) %>%
  dplyr::filter(cellTypes %in% final_celltypes) %>%
  mutate(cellTypes = droplevels(cellTypes))
```

## Predict cell types using SVM with a linear kernel
```{r}
df_3_clusters <- cellTypeClassifier(train_x = x_train, test_x = x_test, model = 'lda')
```


```{r}
computeConcordance(df_3_clusters, sce_3_norm[, sce_3_norm$CellTypes %in% final_celltypes]$CellTypes)
```
```{r}
MLmetrics::Accuracy(df_3_clusters, sce_3_norm[, sce_3_norm$CellTypes %in% final_celltypes]$CellTypes)
```

```{r}
MLmetrics::F1_Score(df_3_clusters, sce_3_norm[, sce_3_norm$CellTypes %in% final_celltypes]$CellTypes)
```

```{r}
classifier_metrics <- ml_test(df_3_clusters, sce_3_norm[, sce_3_norm$CellTypes %in% final_celltypes]$CellTypes, output.as.table = F)
classifier_metrics$balanced.accuracy
classifier_metrics$F1
```

```{r}
classifier_metrics_tab <- ml_test(df_3_clusters, sce_3_norm[, sce_3_norm$CellTypes %in% final_celltypes]$CellTypes, output.as.table = T) %>%
  dplyr::select(balanced.accuracy, F1) %>%
  rownames_to_column(var = "CellTypes")
```


# Generate classification bar-chart
```{r}
conf_matrix <- tibble("Truth" = sce_3_norm[, sce_3_norm$CellTypes %in% final_celltypes]$CellTypes,
                    "Predicted" = df_3_clusters) %>%
  table()

data <- as.data.frame(melt(conf_matrix))
names(data) <- c("Truth", "Predicted", "Count")

# Calculate the total support for each actual class
total_support <- aggregate(Count ~ Truth, data = data, sum)

# Merge total support back to the original data for proportions
data <- merge(data, total_support, by = "Truth", all.x = TRUE)

names(data)[names(data) == "Count.x"] <- "Count"
names(data)[names(data) == "Count.y"] <- "TotalSupport"

# Calculate proportion
data$Proportion <- data$Count / data$TotalSupport

# Creating the plot
ggplot(data, aes(x = Truth, y = Proportion, fill = Predicted)) +
  geom_bar(stat = "identity") +
  labs(title = "Deep Learning - Class Support and Prediction Proportions",
       x = "Truth",
       y = "Proportion of Total Support",
       fill = "Predicted") +
  theme_minimal() + 
  theme_bw() +
    theme(axis.text.x = element_text(size = 12),
        plot.title = element_text(size = 15, hjust = 0.5),
        axis.text.y = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12)
        ) + scale_color_d3(palette = 'category20') + 
  scale_fill_aaas()
```

```{r}
# write balanced accuracy and F1
write.csv(classifier_metrics_tab, '../concordance_data/deep_learning_batch_3_pred_acc.csv',
          row.names = F)

# write plot data
write.csv(data, '../concordance_data/deep_learning_batch_3_pred_data.csv',
          row.names = F)
```


```{r}
df_norm <- assay(sce_norm, "norm") %>%
  t() %>%
  as.data.frame() %>%
  dplyr::mutate(CellTypes = sce_norm$mg_cell_type_distinct) %>%
  dplyr::mutate(Batch = sce_norm$CyTOF.Batch)

df_3_norm <- assay(sce_3_norm, "norm") %>%
  t() %>%
  as.data.frame() %>%
  dplyr::mutate(CellTypes = sce_3_norm$CellTypes) %>%
  dplyr::mutate(Batch = sce_3_norm$Batch)

df_final <- rbind(df_norm, df_3_norm) %>%
  dplyr::filter(CellTypes %in% final_celltypes)
```


```{r}
clusters <- FuseSOM::runFuseSOM(df_final[, useMarkers], markers = useMarkers, numClusters = 10)$clusters
```


```{r}
computeConcordance(clusters, df_final$CellTypes)
```
# Generate UMAP plots and color by batch
## Normalised data

```{r,eval=F}
set.seed(1994)
df_final_sub <- df_final %>% 
  slice_sample(n = 100000)

umap_dat <- umap(df_final_sub[, useMarkers], n_neighbors = 15, verbose = TRUE, n_threads = 7,
                 seed = 1994, init = 'random', scale = "none") %>%
  as.data.frame()


```
```{r}
colnames(umap_dat) <- c('UMAP 1', 'UMAP 2')

umap_dat$`Cell Type` <- df_final_sub$Celltypes
umap_dat$Batch <- df_final_sub$Batch
```


### Plot Batch
```{r, eval=F, fig.width=6, fig.height=4}
colnames(umap_dat) <- c('UMAP 1', 'UMAP 2')

umap_dat$`Cell Type` <- df_final_sub$Celltypes
umap_dat$Batch <- df_final_sub$Batch

umap_dat %>% ggplot(aes(`UMAP 1`, `UMAP 2`)) +
    geom_point(aes(color = Batch), size = 1) + 
    ggtitle('BioHeart-CT - Normalised') +
  theme_bw() +
    theme(axis.text.x = element_text(size = 12),
        plot.title = element_text(size = 20, 
                                  hjust = 0.5, face = 'bold'),
        axis.text.y = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 20)
        ) + scale_color_d3(palette = 'category20')
```

### Plot Cell types
```{r, fig.width=6, fig.height=4}
umap_dat %>% ggplot(aes(`UMAP 1`, `UMAP 2`)) +
    geom_point(aes(color = `Cell Type`), size = 1) + 
    ggtitle('BioHeart-CT - Normalised') +
  theme_bw() +
    theme(axis.text.x = element_text(size = 12),
        plot.title = element_text(size = 20, 
                                  hjust = 0.5, face = 'bold'),
        axis.text.y = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 20),
        ) + scale_color_d3(palette = 'category20')
```


## Unnormalised
```{r}
df$CellTypes <- df$mg_cell_type_distinct
df_final_raw <- rbind(df[, c(useMarkers, "batch_old", "CellTypes")], df_3[, c(useMarkers, "batch_old", "CellTypes")]) %>%
  dplyr::filter(CellTypes %in% final_celltypes)
```

```{r}
set.seed(1994)
  df_final_raw_sub <- df_final_raw %>% 
  slice_sample(n = 100000)

umap_dat_raw <- umap(df_final_raw_sub[, useMarkers], n_neighbors = 15, verbose = TRUE, n_threads = 7,
                 seed = 1994, init = 'random', scale = "none") %>%
  as.data.frame()
```
```{r}
colnames(umap_dat_raw) <- c('UMAP 1', 'UMAP 2')

umap_dat_raw$`Cell Type` <- df_final_raw_sub$CellTypes
umap_dat_raw$Batch <- df_final_raw_sub$batch_old
```


```{r, eval=F, fig.width=6, fig.height=4}
umap_dat_raw %>% ggplot(aes(`UMAP 1`, `UMAP 2`)) +
    geom_point(aes(color = Batch), size = 1) + 
    ggtitle('BioHeart-CT - Raw') +
  theme_bw() +
    theme(axis.text.x = element_text(size = 12),
        plot.title = element_text(size = 20, 
                                  hjust = 0.5, face = 'bold'),
        axis.text.y = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 20),
        legend.position="none"
        ) + scale_color_d3(palette = 'category20')
```

### Cell types
```{r, eval=F, fig.width=6, fig.height=4}
umap_dat_raw %>% ggplot(aes(`UMAP 1`, `UMAP 2`)) +
    geom_point(aes(color = `Cell Type`), size = 1) + 
    ggtitle('BioHeart-CT - Raw') +
  theme_bw() +
    theme(axis.text.x = element_text(size = 12),
        plot.title = element_text(size = 20, 
                                  hjust = 0.5, face = 'bold'),
        axis.text.y = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 20),
        legend.position="none"
        ) + scale_color_d3(palette = 'category20')
```