---
  title: "bioheart Deep Learning"
author: "Elijah WIllie"
date: "2024-03-15"
output: html_document
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = TRUE) 
knitr::opts_chunk$set(fig.width=10, fig.height=6) 
```

```{r}
rm(list = ls())
gc()
suppressPackageStartupMessages({
  library(keras3)
  library(reticulate)
  use_virtualenv('r-keras', required = TRUE)
  library(tensorflow)
  library(tidyverse)
  library(FuseSOM)
  library(ggsci)
  library(uwot)
  library(data.table)
  library(SingleCellExperiment)
  library(caret)
  library(ROCR)
  library(psych)
  library(tensorflow)
  library(glmnet)
  library(data.tree)
  library(ggtree)
  library(ape)
  library(grpregOverlap)
  library(ggiraph)
  library(scales)
  library(ggnewscale)
  library(rstatix)
  library(ggpubr)
})
source('~/Documents/PhD/bioheart_analysis/scripts/helperFuncs.R')
# source('~/Documents/PhD/bioheart_analysis/scripts/vae_kl_model.R')
source('~/Documents/PhD/bioheart_analysis/scripts/vae_model.R')
source('~/Documents/PhD/bioheart_analysis/scripts/customCV.R')
source('~/Documents/PhD/bioheart_analysis/scripts/estimate.ED.R')
source('~/Documents/PhD/bioheart_analysis/scripts/trainClassifier.R')
source('~/Documents/PhD/bioheart_analysis/scripts/deep_learning_helper_funcs.R')
set_random_seed(1994)
```

# load both studies
```{r}
nCores <- 4
BPPARAM <- simpleSeg:::generateBPParam(nCores)
theme_set(theme_classic())
```

# Set the markers
```{r}
useMarkers <- c('HLA_DR', 'CD3', 'CD4', 'CD8a', 'CD25', 'CD127', 'FoxP3', 'CD27',
                'KLRG1', 'CD56', 'CD45RO', 'CD45RA', 'CD192_CCR2', 'CD194_CCR4',
                'CD196_CCR6',
                'CD39', 'CD38', 'Ki67', 'CD183_CXCR3', 'CCR7', 'CD19', 'CD20',
                'IgD', 'CD14', 'CD304', 'CD141', 'CD1c_PE')

allMarkers <- c('HLA_DR', 'CD3', 'CD4', 'CD8a', 'CD25', 'CD127', 'FoxP3', 'CD27',
                'KLRG1', 'CD56', 'CD45RO', 'CD45RA', 'CD192_CCR2', 'CD194_CCR4',
                'CD196_CCR6',
                'CD39', 'CD38', 'Ki67', 'CD183_CXCR3', 'CCR7', 'CD19', 'CD20',
                'IgD', 'CD14', 'CD304', 'CD141', 'CD1c_PE', "CD11b", "CD253_TRAIL",
                "CD34", "CD61", "CD11c", "eNOS", "LOX_1", "CD86", "CD16", "CD45_106",
                "CD45_108", "P2X7", "NOX5")
```


# Read in the dataset
## Study 4
```{r}
# study 4
set.seed(1994)
df <- fread('../raw_data/bioheart_ct_cytof_data_b4_mg.csv',
              nThread = 7) %>%
  as.data.frame()

# rowsum_df <- DelayedMatrixStats::rowSums2(df[, useMarkers] %>% as.matrix())
# df <- df[rowsum_df != 0, ]
```

```{r, eval=FALSE}
df$mg_cell_type_distinct <- dplyr::recode(df$mg_cell_type_distinct,
                             "CD141+ DCs" = "DCs",
                            "CD1c+ DCs" = "DCs",
                            
                             )
```

# asinh norm
```{r}
# df[, useMarkers] <- sqrt(df[, useMarkers])
df[, useMarkers]  <- cyCombine::transform_asinh(df[, useMarkers], markers = useMarkers)
colnames(df)[colnames(df) %in% useMarkers] <- 
  gsub("_", "-", colnames(df)[colnames(df) %in% useMarkers])
```


## Study 3
```{r}
set.seed(1994)
df_3 <- fread('../Study_3_2019/all_batches_processed_mg_10K.csv',
              nThread = 7) %>% 
  as.data.frame()
# %>%
#   group_by(sample_id)
# rowsum_df_3 <- DelayedMatrixStats::rowSums2(df_3[, useMarkers] %>% as.matrix())
# df_3 <- df_3[rowsum_df_3 != 0, ]

# df_3[, useMarkers] <- sqrt(df_3[, useMarkers])
df_3[, useMarkers]  <- cyCombine::transform_asinh(df_3[, useMarkers], markers = useMarkers)
colnames(df_3)[colnames(df_3) %in% useMarkers] <- gsub("_", "-", colnames(df_3)[colnames(df_3) %in% useMarkers])
```
```{r}
useMarkers <- gsub("_", "-", useMarkers)
allMarkers <- gsub("_", "-", allMarkers)

preProcValues <- preProcess(df[, useMarkers], method = c("knnImpute", "range"))

df_scaled <- df
df_3_scaled <- df_3
#
df_scaled[, useMarkers] <- predict(preProcValues, df_scaled[, useMarkers])

df_3_scaled[, useMarkers] <- predict(preProcValues, df_3_scaled[, useMarkers])
```

# Get the reference sample for training
```{r}
res_ind <- ComputeReferenceSample(df_scaled, useMarkers, N = 2)
res_ind_0 <- ComputeReferenceSample(df_scaled[df_scaled$gensini_bin == '0', ], useMarkers, N = 2)
```


# Get the encoding dimensions and the number of clusters 
```{r}
set.seed(1994)
train_dat <- df_scaled[which(df_scaled$sample_id %in% c(res_ind$topNSamples)), ]
val_dat <- df_scaled[which(df_scaled$sample_id %in% c(res_ind$bottomNSamples)), ]
encoding_dim <- FuseSOM::computeGridSize(train_dat[, useMarkers])
```

```{r}
cov_mat <- Rfast::cova(train_dat[, useMarkers] %>% as.matrix())
ED = estimate.ED(x = cov_mat, length(unique(df$sample_id)), cov.mat = T, round.digits = 0)
```
# Define autoencoder model
```{r}
batch_size = 32L
vae_model <- train_vae_model(train_dat = train_dat[, useMarkers], batch_size = batch_size, 
                             useMarkers = useMarkers, epochs = 100, lambda = 0.1, l1_reg = 0,
                             val_dat = val_dat[, useMarkers])
```

  
```{r}
train_decoded <- decode_samples(new_samples = as.matrix(df_scaled[, useMarkers]), 
                                vae = vae_model$vae)
df_norm <- train_decoded[[1]]

colnames(df_norm) <- useMarkers

# preProcValues <- preProcess(df_norm[, useMarkers], method = c("range"))
# df_norm[, useMarkers] <- predict(preProcValues, df_norm[, useMarkers])
```

# Predict on study 3
```{r, eval=T}
test_decoded <- decode_samples(new_samples = as.matrix(df_3_scaled[, useMarkers]), 
                               vae = vae_model$vae)
df_3_norm <- test_decoded[[1]]

colnames(df_3_norm) <- useMarkers
# df_3_norm[, useMarkers] <- predict(preProcValues, df_3_norm[, useMarkers])
```


```{r}
revPredict <- function(preproc, data,digits=0,range = F) {
   if (range == T){
     data<-data %>%
       select(one_of(dimnames(preproc$ranges)[[2]])) %>%
       map2_df(preproc$ranges[2,]-preproc$ranges[1,], ., function(min_max, dat) min_max* dat)  %>%
       map2_df(preproc$ranges[1,], ., function(min, dat) min + dat) %>%
      mutate_if(is.numeric,funs(round(.,digits = digits)))
    return(data)
    }
  data<- data %>%
    select(one_of(names(preproc$mean))) %>%
    map2_df(preproc$std, ., function(sig, dat) dat * sig)  %>%
    map2_df(preproc$mean, ., function(mu, dat) dat + mu) %>%
    mutate_if(is.numeric,funs(round(.,digits = digits)))
  return(data)
}
```

```{r, eval=FALSE}
df_norm_rescaled <- revPredict(preproc = preProcValues, data = df_norm, digits = 8, range = T)
df_3_norm_rescaled <- revPredict(preproc = preProcValues, data = df_3_norm, digits = 8, range = T)
```


# Create SCE object for study 4 and cluster it
```{r}
sce_norm <- SingleCellExperiment(assays = list(norm = t(df_norm[, useMarkers]),
                                               raw = t(df[, useMarkers])
                                               # norm_rescaled = t(df_norm_rescaled[, useMarkers])
),
colData = df %>% dplyr::select(-useMarkers))
reducedDims(sce_norm) <- list(VAE=train_decoded$encoded %>%
                                as.matrix() %>%
                                as.data.frame())
```

# Generate SCE object for study 3
```{r}
sce_3_norm <- SingleCellExperiment(assays = list(norm = t(df_3_norm[, useMarkers]),
                                               raw = t(df_3[, useMarkers])
                                               # norm_rescaled = t(df_3_norm_rescaled[, useMarkers])
),
colData = df_3 %>% dplyr::select(-useMarkers))
reducedDims(sce_3_norm) <- list(VAE=test_decoded$encoded %>%
                                as.matrix() %>%
                                as.data.frame())


```

## Use FuseSOM to cluster the normalised data
```{r, eval=T}
sce_norm$clusters_norm <- NULL
nclust <- 11
sce_norm <- runFuseSOM(sce_norm, numClusters = nclust, assay = 'norm',
                       verbose = FALSE, clusterCol = 'clusters_norm')
```
## Use FuseSOM to cluster the raw data
```{r, eval=FALSE}
sce_norm <- runFuseSOM(sce_norm, numClusters = nclust, assay = 'raw',
                       verbose = FALSE, clusterCol = 'clusters_raw')
```


```{r}
computeConcordance(sce_norm$clusters_norm, sce_norm$mg_cell_type_distinct)
```

# Parse Clinical data for study 4
```{r}
clinicaldata <- colData(sce_norm) %>%
  as.data.frame() %>%
  dplyr::select(sample_id, Gensini, Gender, Age) %>%
  distinct()
clinicaldata$Gensini_bin <- factor(if_else(clinicaldata$Gensini > 0, 1, 0))

# encoded_gender <- model.matrix(~Gender-1, data=clinicaldata)
# clinicaldata <- cbind(clinicaldata, encoded_gender)
# 
# Age <- clinicaldata[match(row_names,clinicaldata$sample_id), 
#                                       "Age"]
# GenderM <- clinicaldata[match(row_names,clinicaldata$sample_id),
#                                       c("GenderM")]
# 
# clinicaldata_info <- cbind(Age, GenderM)

```

# Parse Clinical data for study 4
```{r}

clinicaldata_3 <- colData(sce_3_norm) %>%
  as.data.frame() %>%
  dplyr::select(sample_id, Gensini_bin) %>%
  distinct()
# clinicaldata_3$Gensini_bin <- factor(if_else(clinicaldata_3$Gensini > 0, 1, 0))
# encoded_gender_3 <- model.matrix(~Gender-1, data=clinicaldata_3)
# clinicaldata_3 <- cbind(clinicaldata_3, encoded_gender_3)

# Age_3 <- clinicaldata_3[match(row_names_3,clinicaldata_3$sample_id),
#                                       "Age"]
# GenderM_3 <- clinicaldata_3[match(row_names_3,clinicaldata_3$sample_id),
#                                       c("GenderM")]

# clinicaldata_info_3 <- cbind(Age, GenderM)
```

# Train cell type identification model
## Set up training and testing data
```{r}
x_train <- reducedDim(sce_norm, "VAE") %>%
  # t() %>%
  as.data.frame() %>%
  mutate(cellTypes = factor(sce_norm$clusters_norm)) %>%
  mutate(sample_id = sce_norm$sample_id) %>%
  dplyr::filter(sample_id %in% res_ind$topNSamples) %>%
  # dplyr::group_by(sample_id) %>%
  # dplyr::slice_sample(n = 10000) %>%
  # ungroup() %>%
  dplyr::select(-sample_id) %>%
  mutate(cellTypes = droplevels(cellTypes))

x_test <- reducedDim(sce_3_norm, "VAE") %>%
  # t() %>%
  as.data.frame()

# cols_to_remove <- nearZeroVar(x_train[, 1:ncol(x_train)-1])
# if(length(cols_to_remove) > 0) {
#   x_train <- x_train[, -cols_to_remove]
# x_test <- x_test[, -cols_to_remove]
# }

```

## Predict cell types using SVM with a linear kernel
```{r}
df_3_clusters <- cellTypeClassifier(train_x = x_train, test_x = x_test, model = 'lda')
```
##  Update the test SCE object
```{r}
sce_3_norm$clusters_norm <- df_3_clusters
```


# Compute training features
## Proportions
```{r}
data_logit <- computeFeatures(sce = sce_norm, featureType = 'prop', 
                              cellTypeCol = 'clusters_norm', sampleCol = 'sample_id', 
                              logit = T, useMarkers = useMarkers)
row_names <- rownames(data_logit)
condition <- factor(clinicaldata[match(row_names,clinicaldata$sample_id),
                                      "Gensini_bin"])
```

## Means
```{r, eval=T}
markerMeanCellType <- computeFeatures(sce = sce_norm, featureType = 'mean', 
                              cellTypeCol = 'clusters_norm', sampleCol = 'sample_id', 
                              logit = T, useMarkers = useMarkers)
```


## Compute features on study 3

## Proportions
```{r}
data_3_logit <- computeFeatures(sce = sce_3_norm, featureType = 'prop', 
                              cellTypeCol = 'clusters_norm', sampleCol = 'sample_id', 
                              logit = T, useMarkers = useMarkers)

row_names_3 <- rownames(data_3_logit)
condition_3 <- factor(clinicaldata_3[match(row_names_3,clinicaldata_3$sample_id),
                                      "Gensini_bin"])
```

## Means
```{r, eval=T}
markerMeanCellType_3 <- computeFeatures(sce = sce_3_norm, featureType = 'mean', 
                              cellTypeCol = 'clusters_norm', sampleCol = 'sample_id', 
                              logit = T, useMarkers = useMarkers)
```


# Generate grouping structures
```{r}
trees <- generateTree(features = data_logit, method = "ward")
tree <- trees$tree
order <- trees$order
groups <- generateGroups(tree = tree, nclust = nclust, 
                         proportions = data_logit, means = markerMeanCellType)
```

# Process training and testing data
## Training
```{r}
# Combine all input data matrices
X_train <- cbind(data_logit, markerMeanCellType) %>% 
  as.matrix()
  
  # Scale the combined data
scaleVals <- preProcess(X_train, method = c('range'))
X_train <- predict(scaleVals, X_train)
  
  # Extract response variable
y_train <- condition %>%
    as.numeric()
```

## Testing
```{r}
X_test_study_3 <- cbind(data_3_logit, markerMeanCellType_3) %>%
  as.matrix()
# colnames(X_test_study_3) <- janitor::make_clean_names(colnames(X_test_study_3))
X_test_study_3 <- predict(scaleVals, X_test_study_3)
```

## Fit Overlap model
```{r}
fit <- fitModel(x_train = X_train, y_train = y_train, groups = groups, 
                penalty = 'cMCP')
```

## Predict on test data
```{r}
test_auc <- plotAUC(fit = fit$fit, x_test = X_test_study_3, y_test = condition_3, title = "Study 3 - All AUC =")
test_auc$plot

# write.csv(test_auc$preds,
#           '../auc_data/fs_glasso_auc_all_study_3.csv')

```

# Visualise Resulting Tree
```{r, fig.height=10, fig.width=16}
visualiseModelTree(fit = fit$fit, tree = tree, type = "cluster", 
                   training_data = X_train)
```


# Save SCE objects
```{r, eval=F}
save(sce_norm, file = "../sce_dat/study_4_MMD_VAE_new_sce.RData")
save(sce_3_norm, file = "../sce_dat/study_3_MMD_VAE_new_sce.RData")
```

# Train cell type identification model

# Define cell types of interest
```{r}
final_celltypes <- c(
   "B cells",
   "CD8hi",
   "14+ monos",
   "CD4+ Tconv",
   "CD8lo",
   "NK",
   "16+ monos",
   "CD4+ Treg",
   "pDCs",
   "CD141+ DCs"
    )
```

## Set up training and testing data
```{r}
x_train <- assay(sce_norm, "norm") %>%
  t() %>%
  as.data.frame() %>%
   # mutate(sample_id = sce_norm$sample_id) %>%
  mutate(cellTypes = factor(sce_norm$mg_cell_type_distinct)) %>%
  dplyr::filter(cellTypes %in% final_celltypes) %>%
  # dplyr::filter(sample_id %in% res_ind$topNSamples) %>%
  # dplyr::select(-sample_id) %>%
  mutate(cellTypes = droplevels(cellTypes))

x_test <- assay(sce_3_norm, "norm") %>%
  t() %>%
  as.data.frame() %>%
  mutate(cellTypes = factor(sce_3_norm$CellTypes)) %>%
  dplyr::filter(cellTypes %in% final_celltypes) %>%
  mutate(cellTypes = droplevels(cellTypes))
```

## Predict cell types using SVM with a linear kernel
```{r}
df_3_clusters <- cellTypeClassifier(train_x = x_train, test_x = x_test, model = 'lda')
```

```{r}
computeConcordance(df_3_clusters, sce_3_norm[, sce_3_norm$CellTypes %in% final_celltypes]$CellTypes)
```

```{r}
MLmetrics::Accuracy(df_3_clusters, sce_3_norm[, sce_3_norm$CellTypes %in% final_celltypes]$CellTypes)
```

```{r}
MLmetrics::F1_Score(df_3_clusters, sce_3_norm[, sce_3_norm$CellTypes %in% final_celltypes]$CellTypes)
```

