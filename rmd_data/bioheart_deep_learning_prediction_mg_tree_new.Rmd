---
title: "Bioheart Deep Learning Manual Gating Tree"
author: "Elijah WIllie"
date: "2024-03-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = TRUE) 
knitr::opts_chunk$set(fig.width=10, fig.height=6) 
```


```{r}
rm(list = ls())
gc()
suppressPackageStartupMessages({
  library(keras3)
  library(reticulate)
  use_virtualenv('r-keras', required = TRUE)
  library(tensorflow)
  library(tidyverse)
  library(FuseSOM)
  library(ggsci)
  library(uwot)
  library(data.table)
  library(SingleCellExperiment)
  library(caret)
  library(ROCR)
  library(psych)
  library(tensorflow)
  library(glmnet)
  library(data.tree)
  library(ggtree)
  library(ape)
  library(grpregOverlap)
  library(ggiraph)
  library(scales)
  library(ggnewscale)
  library(rstatix)
  library(ggpubr)
})
source('~/Documents/PhD/bioheart_analysis/scripts/helperFuncs.R')
source('~/Documents/PhD/bioheart_analysis/scripts/vae_class_model.R')
source('~/Documents/PhD/bioheart_analysis/scripts/vae_model.R')
source('~/Documents/PhD/bioheart_analysis/scripts/customCV.R')
source('~/Documents/PhD/bioheart_analysis/scripts/deep_learning_helper_funcs.R')
set_random_seed(1994)
```

# load both studies
```{r}
nCores <- 4
BPPARAM <- simpleSeg:::generateBPParam(nCores)
theme_set(theme_classic())
```

# Set the markers
```{r}
useMarkers <- c('HLA_DR', 'CD3', 'CD4', 'CD8a', 'CD25', 'CD127', 'FoxP3', 'CD27',
                'KLRG1', 'CD56', 'CD45RO', 'CD45RA', 'CD192_CCR2', 'CD194_CCR4',
                'CD196_CCR6',
                'CD39', 'CD38', 'Ki67', 'CD183_CXCR3', 'CCR7', 'CD19', 'CD20',
                'IgD', 'CD14', 'CD304', 'CD141', 'CD1c_PE')

allMarkers <- c('HLA_DR', 'CD3', 'CD4', 'CD8a', 'CD25', 'CD127', 'FoxP3', 'CD27',
                'KLRG1', 'CD56', 'CD45RO', 'CD45RA', 'CD192_CCR2', 'CD194_CCR4',
                'CD196_CCR6',
                'CD39', 'CD38', 'Ki67', 'CD183_CXCR3', 'CCR7', 'CD19', 'CD20',
                'IgD', 'CD14', 'CD304', 'CD141', 'CD1c_PE', "CD11b", "CD253_TRAIL",
                "CD34", "CD61", "CD11c", "eNOS", "LOX_1", "CD86", "CD16", "CD45_106",
                "CD45_108", "P2X7", "NOX5")
```


# Read in the dataset
## Study 4
```{r}
# study 4
set.seed(1994)
df <- fread('../raw_data/bioheart_ct_cytof_data_b4_mg.csv',
              nThread = 7) %>%
  as.data.frame()

df_asinh <- df
# df_asinh <- df[rowsum_df != 0, ]
```

```{r, eval=FALSE}
df$mg_cell_type_distinct <- dplyr::recode(df$mg_cell_type_distinct,
                             "CD141+ DCs" = "DCs",
                            "CD1c+ DCs" = "DCs",
                            
                             )
```

# asinh norm
```{r}
df_asinh[, useMarkers] <- cyCombine::transform_asinh(df_asinh[, useMarkers], markers = useMarkers)

preProcValues <- preProcess(df_asinh[, useMarkers], method = c("range"))
#
df_asinh[, useMarkers] <- predict(preProcValues, df_asinh[, useMarkers])
```

```{r, eval=FALSE}
df_asinh %>% 
  group_by(sample_id) %>%
  dplyr::select(useMarkers) %>%
  dplyr::select(-sample_id) %>%
  as.data.frame() %>%
  melt() %>%
  ggplot(aes(x = value, fill = variable)) +
  geom_histogram() +
  facet_wrap(~variable, scales = "free_x") + 
  labs(title = "Asinh") +
    theme_minimal() + 
    theme_bw() +
    theme(axis.text.x = element_text(size = 16,
                                     angle = 90, vjust = 0.5, hjust=1),
          plot.title = element_text(size = 20, hjust = 0.5),
          axis.text.y = element_text(size = 16),
          axis.title.y = element_text(size = 16),
          axis.title.x = element_text(size = 16),
          legend.text = element_text(size = 16),
          legend.title = element_text(size = 16),
          legend.position = 'None'
    )
```


## Study 3
```{r}
set.seed(1994)
# bad_samples <- c(222L, 313L, 349L, 387L, 505L, 667L, 725L, 794L, 874L)
df_3 <- fread('../Study_3_2019/all_batches_processed_mg_10K.csv',
              nThread = 7) %>% 
  as.data.frame()

# %>%
#   group_by(sample_id)
df_3[, useMarkers] <- cyCombine::transform_asinh(df_3[, useMarkers], markers = useMarkers)
df_3[, useMarkers] <- predict(preProcValues, df_3[, useMarkers])
```

```{r, eval=T}
res <- fitVAES(train_dat = df_asinh, test_dat = df_3, batch_size = 16, 
               latent_dim = 16L, dropout_rate = 0.0,
               useMarkers = useMarkers, k = 2, epochs = 80)
```


# Get the reference sample for training
```{r, eval=FALSE}
res_ind <- ComputeReferenceSample(df_asinh, useMarkers)
```


# Get the encoding dimensions and the number of clusters 
```{r, eval=FALSE}
set.seed(1994)
# train_dat <- df_asinh
train_dat <- df_asinh[which(df_asinh$sample_id %in% c(res_ind$refSampleInd)), ]
encoding_dim <- FuseSOM::computeGridSize(train_dat[, useMarkers])
```

```{r, eval=FALSE}
set.seed(1994)
cell_types <- kmeans(train_dat[, useMarkers], centers = 11)$cluster
```

# Define autoencoder model
```{r, eval=FALSE}
# models <- autoEncoderModel(train_dat = train_dat[, useMarkers], input_size = length(useMarkers),
#                            encoding_dim = encoding_dim*2, l2_reg = 0, 
#                            dropout_rate = 0.2, epochs = 300) 
batch_size = 16L
latent_dim <- 16L
vae_model <- train_vae_class_model(train_dat = train_dat[, useMarkers], batch_size = batch_size, 
                                   cell_types = cell_types,
                             useMarkers = useMarkers, epochs = 60, latent_dim = latent_dim)
```

# Predict on study 4
```{r, eval=FALSE}
# df_norm <- predict(models$autoencoder_model, as.matrix(df_asinh[, useMarkers])) %>%
#   as.data.frame()
train_decoded <- decode_samples(new_samples = as.matrix(df_asinh[, useMarkers]), 
                                vae = vae_model$vae, batch_size = batch_size, latent_dim = latent_dim)
df_norm <- train_decoded[[1]]

colnames(df_norm) <- useMarkers
```

```{r, eval=FALSE}
df_norm$sample_id <- df_asinh$sample_id

df_norm %>% 
  # group_by(sample_id) %>%
  dplyr::select(useMarkers) %>%
  # dplyr::select(-sample_id) %>%
  as.data.frame() %>%
  melt() %>%
  ggplot(aes(x = value, fill = variable)) +
  geom_histogram() +
  facet_wrap(~variable, scales = "free_x") + 
  labs(title = "Asinh Auto Encoder") +
    theme_minimal() + 
    theme_bw() +
    theme(axis.text.x = element_text(size = 16,
                                     angle = 90, vjust = 0.5, hjust=1),
          plot.title = element_text(size = 20, hjust = 0.5),
          axis.text.y = element_text(size = 16),
          axis.title.y = element_text(size = 16),
          axis.title.x = element_text(size = 16),
          legend.text = element_text(size = 16),
          legend.title = element_text(size = 16),
          legend.position = 'None'
    )
```


# Create SCE object for study 4 and cluster it
```{r}
df_norm <- res$train %>%
  as.data.frame()
colnames(df_norm) <- useMarkers
df_norm$clusters <- df$mg_cell_type_distinct

sce_norm <- SingleCellExperiment(assays = list(norm = t(df_norm[, useMarkers]),
                                               raw = t(df_asinh[, useMarkers])
),
colData = df_asinh %>% dplyr::select(-useMarkers))
# reducedDims(sce_norm) <- list(VAE=train_decoded$encoded %>%
#                                 as.matrix() %>%
#                                 as.data.frame())

# nclust <- length(unique(sce_norm$mg_cell_type_clean))
```

# Predict on study 3
```{r, eval=FALSE}
# df_3_norm <- predict(models$autoencoder_model, as.matrix(df_3[, useMarkers])) %>%
#   as.data.frame()
test_decoded <- decode_samples(new_samples = as.matrix(df_3[, useMarkers]), 
                               vae = vae_model$vae,batch_size = batch_size, 
                               latent_dim = latent_dim)
df_3_norm <- test_decoded[[1]]

colnames(df_3_norm) <- useMarkers
```
# Train clustering model
## Select training data 
```{r, eval=FALSE}
set.seed(1994)
df_norm$clusters <- factor(sce_norm$mg_cell_type_distinct)
df_norm$sample_id <- sce_norm$sample_id
df_norm$clusters <- droplevels(df_norm$clusters)
# df_norm <- df_norm[df_norm$clusters != "others", ]
# df_norm <- df_norm[df_norm$clusters != "", ]

# df_norm_sub <- df_norm[which(df$sample_id == res_ind$refSampleInd), ]

# %>%
# dplyr::select(-sample_id)

min_val <- min(table(droplevels(df_norm$clusters)))
# #
df_norm_sub <- df_norm 
```


```{r, eval=F}
preds <- model %>%
  predict(as.matrix(df_3_norm[, useMarkers]), class_weights = weights)

preds <- max.col(preds) - 1L
preds <- as.factor(preds)

levels(preds) <- levels(droplevels(df_norm_sub$clusters))
df_3_clusters <- preds
table(df_3_clusters)
```

```{r, eval=T}
y_train <- df_norm$clusters
df_norm <- df_norm[, useMarkers]
df_norm <- df_norm[,apply(df_norm, 2, var, na.rm=TRUE) > 1e-08]
LDAclassifier <- MASS::lda(df_norm,y_train)
```


```{r, eval=T}
df_3_norm <- res$test %>%
  as.data.frame()
colnames(df_3_norm) <- useMarkers
Predictions <- predict(LDAclassifier,df_3_norm[, colnames(df_norm)])
df_3_clusters <- Predictions$class

table(df_3_clusters)

# df_3_clusters <- test_decoded$cell_types %>%
#   as.factor()
# levels(df_3_clusters) <- levels(droplevels(train_dat$mg_cell_type_distinct %>% as.factor()))
```

```{r, eval=F}
latent_dim <- 16
nclust <- length(unique(df$mg_cell_type_distinct))
class_model <- keras_model_sequential(input_shape = length(useMarkers)) %>%
  layer_dense(units = latent_dim, activation = 'relu') %>%
  layer_dense(units = latent_dim/2, activation = "relu") %>%
  layer_dense(units = nclust, 
                activation = "softmax", name = "cell_type_pred", 
                kernel_regularizer = regularizer_l1_l2(0))
```

```{r, eval=FALSE}
class_model %>% compile(
        optimizer = "adam",
        loss = "categorical_focal_crossentropy",
        metrics = c(keras3::metric_auc(multi_label = TRUE))
)

  
```


```{r, eval=FALSE}
 # Train the VAE model
set.seed(1994)
y_train <- to_categorical(as.numeric(as.factor(df_norm$clusters)) - 1)
class_model %>% fit(x = df_norm[, useMarkers] %>% as.matrix(), y = y_train, epochs = 10, 
              shuffle = TRUE,
              validation_split = 0.3,
              batch_size = 128)
```



```{r, eval=FALSE}
y_pred <- predict(class_model, df_3_norm %>% as.matrix())
df_3_clusters <- (apply(y_pred, 1, which.max) - 1) %>%
  as.factor()
levels(df_3_clusters) <- levels(droplevels(as.factor(df_norm$clusters)))
table(df_3_clusters)
```

## Compute features on study 3
### Generate SCE object and populate clusters
```{r}
sce_3_norm <- SingleCellExperiment(assays = list(raw = t(df_3[,useMarkers]),
                                                 norm = t(df_3_norm[, useMarkers])
                                          ),
                                 colData = df_3[, setdiff(colnames(df_3), useMarkers)])
# reducedDims(sce_3_norm) <- list(VAE=test_decoded$encoded %>%
#                                   as.matrix() %>%
#                                   as.data.frame())
sce_3_norm$clusters <- df_3_clusters
```

# Compute training features
## Proportions
```{r}
sce_norm_sub <- sce_norm[, sce_norm$mg_cell_type_distinct != "other"]
sce_norm_sub <- sce_norm_sub[, sce_norm_sub$mg_cell_type_distinct != ""]
# do prediction
data <- getProp(sce_norm_sub,
                feature = "mg_cell_type_distinct", imageID = "sample_id", logit = F)

dat_prop <- data
data <- 2*asin(sqrt(data))

clinicaldata <- colData(sce_norm_sub) %>%
  as.data.frame() %>%
  dplyr::select(sample_id, Gensini, Gender, Age) %>%
  distinct()
clinicaldata$Gensini_bin <- factor(if_else(clinicaldata$Gensini > 0, 1, 0))

encoded_gender <- model.matrix(~Gender-1, data=clinicaldata)
clinicaldata <- cbind(clinicaldata, encoded_gender)

row_names <- rownames(data)

Age <- clinicaldata[match(row_names,clinicaldata$sample_id),
                                      "Age"]
GenderM <- clinicaldata[match(row_names,clinicaldata$sample_id),
                                      c("GenderM")]

clinicaldata_info <- cbind(Age, GenderM)

condition <- factor(clinicaldata[match(row_names,clinicaldata$sample_id),
                                      "Gensini_bin"])


data_logit <- getProp(sce_norm_sub,
                feature = "mg_cell_type_distinct", imageID = "sample_id", logit = T)
colnames(data_logit) <- paste0(colnames(data_logit), "_logit")
# colnames(data) <- paste0(colnames(data), "_prop")
colnames(dat_prop) <- colnames(data)
```

## Mean expression
```{r}
t <- assay(sce_norm_sub, 'norm') %>%
  t() %>%
  as.data.frame()
t$sample_id <- sce_norm_sub$sample_id

data_mean <- t %>% 
  dplyr::group_by(sample_id) %>%
  dplyr::summarise_at(vars(useMarkers), mean) %>%
  dplyr::select(-sample_id) %>%
  as.data.frame()

data_median <- t %>% 
  group_by(sample_id) %>%
  summarise_at(vars(useMarkers), median) %>%
  dplyr::select(-sample_id) %>%
  as.data.frame()

rownames(data_mean) <- clinicaldata$sample_id
rownames(data_median) <- clinicaldata$sample_id
colnames(data_mean) <- paste0(colnames(data_mean), "_mean")
colnames(data_median) <- paste0(colnames(data_median), "_median")
```

## Generate features for Study 3
### Proportions
```{r}
sce_3_norm_sub <- sce_3_norm[, sce_3_norm$clusters != "other"]
sce_3_norm_sub <- sce_3_norm_sub[, sce_3_norm_sub$clusters != ""]
sce_3_norm_sub$clusters <- droplevels(sce_3_norm_sub$clusters)

data_3 <- getProp(sce_3_norm_sub,
                feature = "clusters", imageID = "sample_id", logit = F)


data_3 <- 2*asin(sqrt(data_3))

colnames(data_3) <- janitor::make_clean_names(colnames(data_3))

clinicaldata_3 <- colData(sce_3_norm_sub) %>%
  as.data.frame() %>%
  dplyr::select(sample_id, Gensini_bin) %>%
  distinct()
# clinicaldata_3$Gensini_bin <- factor(if_else(clinicaldata_3$Gensini > 0, 1, 0))
# encoded_gender_3 <- model.matrix(~Gender-1, data=clinicaldata_3)
# clinicaldata_3 <- cbind(clinicaldata_3, encoded_gender_3)

row_names_3 <- rownames(data_3)

# Age <- clinicaldata_3[match(row_names_3,clinicaldata_3$sample_id),
#                                       "Age"]
# GenderM <- clinicaldata_3[match(row_names_3,clinicaldata_3$sample_id),
#                                       c("GenderM")]
# 
# clinicaldata_info_3 <- cbind(Age, GenderM)

data_3_logit <- getProp(sce_3_norm_sub,
                feature = "clusters", imageID = "sample_id", logit = T)

condition_3 <- factor(clinicaldata_3[match(row_names_3,clinicaldata_3$sample_id),
                                      "Gensini_bin"])

colnames(data_3_logit) <- paste0(colnames(data_3_logit), "_logit")
# colnames(data_3) <- paste0(colnames(data_3), "_prop")
```


### Mean expression
```{r}
t_3 <- assay(sce_3_norm_sub, 'norm') %>%
  t() %>%
  as.data.frame()
t_3$sample_id <- sce_3_norm_sub$sample_id

t_3_mean <- t_3 %>% 
  group_by(sample_id) %>%
  summarise_at(vars(useMarkers), mean) %>%
  dplyr::select(-sample_id) %>%
  as.data.frame()

t_3_median <- t_3 %>% 
  group_by(sample_id) %>%
  summarise_at(vars(useMarkers), median) %>%
  dplyr::select(-sample_id) %>%
  as.data.frame()

rownames(t_3_mean) <- clinicaldata_3$sample_id
rownames(t_3_median) <- clinicaldata_3$sample_id

colnames(t_3_mean) <- paste0(colnames(t_3_mean), "_mean")
colnames(t_3_median) <- paste0(colnames(t_3_median), "_median")
```


# Marker mean per cell type
## Training data
```{r}
coldat <- colData(sce_norm) %>%
  as.data.frame()

# Protein mean per cell type
markerDf = 
  coldat |> 
  dplyr::select(sample_id, mg_cell_type_distinct) |> 
  cbind(data.frame(t(assay(sce_norm, "norm")))) |>
  dplyr::select(sample_id, mg_cell_type_distinct,useMarkers) %>%
  dplyr::filter(mg_cell_type_distinct != "") %>%
  dplyr::filter(mg_cell_type_distinct != "other")

# Mean marker per cell type
markerMeanCellType = markerDf |> 
  group_by(sample_id, mg_cell_type_distinct) |> 
  summarise_at(vars(-group_cols()), mean, na.rm = TRUE) |> 
  pivot_longer(-c(sample_id, mg_cell_type_distinct), names_to = "markers") |> 
  pivot_wider(names_from = c(mg_cell_type_distinct, markers), values_from = value) |> 
  column_to_rownames("sample_id") %>% 
  replace(is.na(.), 0) 

# medians <- apply(markerMeanCellType, 2, median)
# mad_values <- apply(markerMeanCellType, 2, mad_scaled)
# 
# markerMeanCellType <- sweep(markerMeanCellType, 2, medians, FUN = "-")
# markerMeanCellType <- sweep(markerMeanCellType, 2, mad_values, FUN = "/")

```

# Testing data
```{r}
coldat_3 <- colData(sce_3_norm) %>%
  as.data.frame()

# Protein mean per cell type
markerDf_3 = 
  coldat_3 |> 
  dplyr::select(sample_id, clusters) |> 
  cbind(data.frame(t(assay(sce_3_norm, "norm")))) |>
  dplyr::select(sample_id, clusters, useMarkers) %>%
  dplyr::filter(clusters != "") %>%
  dplyr::filter(clusters != "other")


# Mean marker per cell type
markerMeanCellType_3 = markerDf_3 |> 
  group_by(sample_id, clusters) |> 
  summarise_at(vars(-group_cols()), mean, na.rm = TRUE) |> 
  pivot_longer(-c(sample_id, clusters), names_to = "markers") |> 
  pivot_wider(names_from = c(clusters, markers), values_from = value) |> 
  column_to_rownames("sample_id") %>% 
  replace(is.na(.), 0)

# medians_3 <- apply(markerMeanCellType_3, 2, median)
# mad_values_3 <- apply(markerMeanCellType_3, 2, mad_scaled)
# 
# markerMeanCellType_3 <- sweep(markerMeanCellType_3, 2, medians_3, FUN = "-")
# markerMeanCellType_3 <- sweep(markerMeanCellType_3, 2, mad_values_3, FUN = "/")
```

```{r, eval=T}
root <- Node$new("Root")
  myeloid <- root$AddChild('Myeloid_logit')
    `14+ monos` <- myeloid$AddChild('14+ monos_logit')
    `16+ monos` <- myeloid$AddChild('16+ monos_logit') 
    pDCs <- myeloid$AddChild('pDCs_logit')
    `CD141+ DCs` <- myeloid$AddChild('CD141+ DCs_logit')
    `CD1c+ DCs` <- myeloid$AddChild('CD1c+ DCs_logit')
  NK <- root$AddChild('NK_logit')
  `B cells` <- root$AddChild('B cells_logit')
  CD3 <- root$AddChild('CD3_logit')
    CD8hi <- CD3$AddChild('CD8hi_logit')
    CD8lo <- CD3$AddChild('CD8lo_logit')
    CD4 <- CD3$AddChild('CD4_logit')
      `CD4+ Tconv` <- CD4$AddChild('CD4+ Tconv_logit')
      `CD4+ Treg` <- CD4$AddChild('CD4+ Treg_logit')
  # other <- root$AddChild('other_logit')
```

```{r, eval=T}
# d_logit <- coop::pcor(data_logit) %>%
#   cor2dist() %>%
#   as.dist()
# hc_logit <- hclust(d_logit, method = 'ward')
# hc_logit <- mhca::fixNonMonotHca(hc_logit)
# Extract clusters from the dendrogram
hc_logit <- treekoR:::findChildren(ggtree(as.phylo(root),
                                            ladderize = F, layout = 'dendrogram'))
# Extract clusters and assign group numbers
subs_logit <- hc_logit$data$clusters
logit_dat <- hc_logit$data
logit_dat$group <- 1:length(subs_logit)
```

```{r}
nclust <- ncol(data)
# Prepare variable groups for overlapping group Lasso
var_groups<- list()
n <- length(subs_logit)
# n2 <- 2*n
for(i in 1:length(subs_logit)){
    var_groups[[i]] <- which(janitor::make_clean_names(colnames(data_logit)) %in% 
                               janitor::make_clean_names(subs_logit[[i]]))
    # var_groups[[i+n]] <- which(make_clean_names(colnames(data_logit)) %in% 
    #                              make_clean_names(subs_logit[[i]])) + nclust
  }
  
```

```{r, eval=F}
off_set <- length(var_groups)
for(i in 1:length(subs_logit)){
  index <- off_set + i  # Calculate the new index in the list
  to_match <- make_clean_names(subs_logit[[i]]) %>%
    str_remove("_logit")
  space <- make_clean_names(colnames(markerMeanCellType))
  
  matches <- unique(grep(paste(to_match,collapse="|"), 
                          space, value=F)) + nclust
  var_groups[[index]] <- matches
  # print(to_match)
  # print(matches)
}

```


```{r, eval=T}
celltypes <- unique(df_norm$clusters)
celltypes <- celltypes[celltypes != ""]
celltypes <- celltypes[celltypes != "other"]
last_max <- 11
off_set <- length(var_groups)
for (i in 1:ncol(markerMeanCellType)) {
  index <- off_set + i  # Calculate the new index in the list
  begin <- last_max + 1        # Start the next sequence right after the last max
  end <- begin # Each sublist has exactly 27 items

  # Add the new sequence to the res list at the new index
  var_groups[[index]] <- seq(begin, end)

  # Update last_max for the next iteration
  last_max <- end
}

# var_groups[off_set + 1] <- list(seq(last_max + 1, ncol(markerMeanCellType) + last_max))
```


```{r}
# Combine all input data matrices
X_train <- cbind(data_logit, markerMeanCellType) 
# colnames(X_train) <- janitor::make_clean_names(colnames(X_train))
  
  # Scale the combined data
scaleVals <- preProcess(X_train, method = c('range'))
X_train <- predict(scaleVals, X_train) %>%
    as.matrix()
# X_train[, 1:nclust] <- X_train[, 1:nclust]/nclust
# X_train[, (nclust+1):ncol(markerMeanCellType)] <- X_train[, (nclust+1):ncol(markerMeanCellType)]/(nclust*length(markerMeanCellType))
  
  # Extract response variable
y_train <- condition %>%
    as.numeric()
```

```{r}
X_test_study_3 <- cbind(data_3_logit, markerMeanCellType_3) %>%
  as.matrix()
# colnames(X_test_study_3) <- janitor::make_clean_names(colnames(X_test_study_3))
X_test_study_3 <- predict(scaleVals, X_test_study_3)
# X_test_study_3[, 1:nclust] <- X_test_study_3[, 1:nclust]/nclust
# X_test_study_3[, (nclust+1):ncol(markerMeanCellType)] <- X_test_study_3[, (nclust+1):ncol(markerMeanCellType)]/(nclust*length(markerMeanCellType))
```

```{r, eval=FALSE}
res.cv <- KFoldCustomEnsembleAlpha(dat_prop = data, dat_logit = data_logit, 
                              dat_mean = markerMeanCellType, root = root,
                              train_y = condition,  alpha_search = seq(0.1, 1, 0.1),
                              nRepeats = 1, k = 10, seed = 999, numMarkers = 27)
```

```{r,eval=FALSE}
# Ensure y_train is binary (0 or 1)
# y_train <- if_else(condition == 1, 1, 0)

# Fit the logistic regression model
# set.seed(999)

grp_weights <- compute_weights(x_train = X_train, y_train = y_train, groups = var_groups)
# If there are additional steps or outputs needed, add them here
# For example, printing the group weights
print(grp_weights)

```

```{r, eval=T}
alpha_search = seq(0.01, 0.1, 0.01)
res_aic <- selectApha(X_train, y_train, alpha_search = alpha_search,
                      groups = var_groups, penalty = 'grMCP', seed = 1994)
```


```{r}
alpha <- alpha_search[computeElbow(res_aic$aics)]
cvfit <- cv.grpregOverlap(X_train, y_train, var_groups, penalty = 'grMCP',
                          seed = 1994,
                            family = 'binomial',  alpha = alpha, nfolds = 10)
# Plot cross-validation results]
par(mfrow=c(2,2))
plot(cvfit, type = "all")

# Fit overlapping group Lasso model
fit <- grpregOverlap(X_train, y_train, var_groups,
                     seed = 1994,
                       family='binomial', alpha = alpha,
                       returnX.latent = T, returnOverlap = FALSE,
                       lambda = cvfit$lambda.min, penalty = 'grMCP')

# fit <- res_aic$best_fit
```

## Predict on test data
```{r}
pred_study_3 <- predict(fit, X = X_test_study_3,
                        type = "response")

write.csv(as.data.frame(pred_study_3),
          '../auc_data/mg_model_auc_study_3.csv')

pred_study_3 <- prediction(pred_study_3, condition_3) 
pred_study_3_perf <- ROCR::performance(pred_study_3, "tpr", "fpr")


plt_dat_3 = data.frame(
  FPR = pred_study_3_perf@x.values[[1]],
  TPR = pred_study_3_perf@y.values[[1]]
)

auc_perf_study_3 <- ROCR::performance(pred_study_3, measure = "auc")
auc_study_3 <- auc_perf_study_3@y.values[[1]]
```

```{r}
# Generate AUC plot
ggplot(plt_dat_3, aes(x = FPR, y = TPR)) +
  geom_line(colour = "blue") +
  labs(x = pred_study_3_perf@x.name, y = pred_study_3_perf@y.name) +
  geom_abline(slope = 1, intercept = 0) + theme_bw() +
  theme(
    plot.title = element_text(color="Black", size=16, face="bold", hjust = 0.5),
    plot.subtitle = element_text(color = "red", size = 16, hjust = 0.5),
    axis.title.x = element_text(color="Black", size=16),
    axis.title.y = element_text(color="Black", size=16),
    axis.text.y = element_text(size = 16),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 16),
    strip.text.x = element_text(size = 16),
    legend.title = element_text(size=16), #change legend title font size
    legend.text = element_text(size=16) #change legend text font size)
  )  + ggtitle(paste("Overlap Group Lasso MG- Study 3 - AUC =", round(auc_study_3, 2)))
```
# Plot overlap tree
```{r}
coefs <- coef(fit) %>%
  as.matrix() %>%
  as.data.frame()
coefs$feature <- rownames(coefs) %>%
  janitor::make_clean_names()

res_mp <- MP_gLasso(fit = fit, group = fit$grp.vec, lambda.type = "min", sort.type = "max")
```

## Proportions
```{r, fig.height=6, fig.width=12}
p <- plotOverlapTree(hc = hc_logit, coefs = coefs, type = 'logit',
                     data = res_mp$data, heatmap = F)
```

# Extract the non-zero coefficients and non logit coeficients
```{r}
coefs$feature <- rownames(coefs)
coefs  <- coefs %>%
  dplyr::filter(!feature %like% "logit")%>%
  dplyr::filter(!feature %like% "(Intercept)")
```

```{r}
coefs$Cell_Type <- gsub("_.*", "", coefs$feature)  # Remove everything after the underscore
coefs$Marker <- sub(".*_", "", coefs$feature)  # Remove everything before and including the underscore

# Pivot the data to wide format
coefs_wide <- coefs %>%
  dplyr::select(Cell_Type, Marker, V1) %>%
  pivot_wider(names_from = Cell_Type, values_from = V1) %>%
  as.data.frame()

rownames(coefs_wide) <- coefs_wide$Marker

coefs_wide <- coefs_wide %>%
  dplyr::select(-Marker)

colnames(coefs_wide) <- janitor::make_clean_names(colnames(coefs_wide))
```


```{r}
gheatmap(p, data = t(coefs_wide), offset = 0.05, hjust = 1, colnames_offset_y = 0, 
         color = 'white',legend_title="Logit Proportions") +
  # vexpand(.001, -1) + 
      theme(legend.title = element_text(color = "black", size = 10),
            legend.text = element_text(color = "black", size = 10)) + 
  scale_fill_gradientn(colours = eval(formals(pheatmap::pheatmap)$color, 
                                      envir=environment(pheatmap::pheatmap)), 
                       name = "Model Coefficient")
```

```{r}
# colnames(data_logit) <- make_clean_names(colnames(data_logit))
# colnames(markerMeanCellType) <- make_clean_names(colnames(markerMeanCellType))
```

# plot elbows for alpha selection
```{r}
plotData <- data.frame(
      Alpha = seq(0.01, 0.1, 0.01),
      AIC = res_aic$aics[1:10]
    )

ggpubr::ggline(
    plotData,
    x = "Alpha", y = 'AIC', group = 1, color = "steelblue"
  ) +
    geom_vline(xintercept = alpha*100, linetype = 1, color = "red") +
    labs(
      y = "AIC", x = "Alpha",
      title = "Optimal Alpha using the elbow method"
    ) +
    theme(
      plot.title = element_text(
        color = "Black", size = 14, face = "bold", hjust = 0.5
      ),
      axis.title.x = element_text(color = "Black", size = 14, face = "bold"),
      axis.title.y = element_text(color = "Black", size = 14, face = "bold")
    )
```

# Fit a baseline Lasso model
```{r, eval=FALSE}
set.seed(999)
cv.lasso <- cv.glmnet(X_train, condition, family='binomial', alpha=1, parallel=TRUE, 
                      standardize=F, relax = F, type.measure = 'auc',nfolds = 10)
plot(cv.lasso)
coef(cv.lasso, s='lambda.min')
coef <- coef(cv.lasso, s='lambda.min')
selected_attributes <- (coef@i[-1]+1)

```

```{r, eval=FALSE}
pred_test <- predict(cv.lasso, newx = X_test_study_3, 
                     type = "response", s = 'lambda.min')

write.csv(as.data.frame(pred_test),
          '../auc_data/mg_model_baseline_auc_study_3.csv')


pred_fs <- prediction(pred_test, condition_3)
perf_fs <- ROCR::performance(pred_fs, "tpr", "fpr")


plt_dat = data.frame(
  FPR = perf_fs@x.values[[1]],
  TPR = perf_fs@y.values[[1]]
)

auc_perf <- ROCR::performance(pred_fs, measure = "auc")
auc <- auc_perf@y.values[[1]]

# generate AUC plot
p_auc <- ggplot(plt_dat, aes(x = FPR, y = TPR)) +
  geom_line(colour = "blue") +
  labs(x = perf_fs@x.name, y = perf_fs@y.name) +
  geom_abline(slope = 1, intercept = 0) + theme_bw() +
  theme(
    plot.title = element_text(color="Black", size=16, face="bold", hjust = 0.5),
    plot.subtitle = element_text(color = "red", size = 16, hjust = 0.5),
    axis.title.x = element_text(color="Black", size=16),
    axis.title.y = element_text(color="Black", size=16),
    axis.text.y = element_text(size = 16),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 16),
    strip.text.x = element_text(size = 16),
    legend.title = element_text(size=16), #change legend title font size
    legend.text = element_text(size=16) #change legend text font size)
  )  + ggtitle(paste("Test Set - AUC =", round(auc, 2)))

p_auc
```

## Look at heatmap
```{r, fig.height=6, fig.width=8,eval=T}
scater::plotGroupedHeatmap(sce_norm, 
                           features = useMarkers, 
                           group = "mg_cell_type_distinct", 
                           block = "mg_cell_type_distinct",
                           exprs_values = "norm",
                           center = TRUE, 
                           scale = TRUE, 
                           zlim = c(-2,2),
                           cluster_rows = FALSE)
```

```{r}
coefs_sub <- coefs %>%
  dplyr::filter(V1 != 0)
```

```{r}
sig_features <- markerMeanCellType %>%
  dplyr::select(coefs_sub$feature) %>%
  mutate(sample_id = as.integer(rownames(.))) %>%
  left_join(clinicaldata)
```

# Compute pvalues and adjust for multiple testing
```{r}
stats <- sig_features %>% 
  group_by(Gensini_bin) %>%
  dplyr::select(coefs_sub$feature) %>%
  # dplyr::select(-sample_id) %>%
  as.data.frame() %>%
  melt() %>%
  mutate(feature = variable) %>%
  group_by(feature) %>%
  t_test(value ~ Gensini_bin) %>%
  adjust_pvalue(method = "bonferroni") %>%
  add_significance("p.adj") %>%
  add_xy_position(x = 1, dodge = 0.0) %>%
  filter(p.adj < 0.05)
```


```{r}
# CCR2 (OR 1.12), CCR4 (OR 1.08), CD38 and CD45RO (OR 1.13), HLA-DR (OR 1.06), and Ki67 (1.22)

sig_features %>% 
  group_by(Gensini_bin) %>%
  dplyr::select(stats$feature) %>%
  # dplyr::select(-sample_id) %>%
  as.data.frame() %>%
  melt() %>%
  mutate(feature = variable) %>%
  ggboxplot(x = 'Gensini_bin', y = 'value',
            color = 'Gensini_bin', palette = 'jco',
            facet.by = 'feature', scale = 'free_y') +
  labs(title = "") +
    theme_minimal() + 
    theme_bw() +
    theme(axis.text.x = element_text(size = 16),
          plot.title = element_text(size = 20, hjust = 0.5),
          axis.text.y = element_text(size = 16),
          axis.title.y = element_text(size = 16),
          axis.title.x = element_text(size = 16),
          legend.text = element_text(size = 16),
          legend.title = element_text(size = 16),
          legend.position = 'None',
          strip.text.x = element_text(size = 16, colour = "black", face = 'bold')
    ) + stat_pvalue_manual(
  stats,  label = "p.adj.signif", tip.length = 0,
  size = 6, color = 'red'
  ) + scale_y_continuous(expand = expansion(mult = c(0, 0.1)))
```

# Repeat for the test set
```{r}
coefs_sub <- coefs %>%
  dplyr::filter(V1 != 0)
```

```{r}
sig_features_test <- markerMeanCellType_3 %>%
  dplyr::select(coefs_sub$feature) %>%
  mutate(sample_id = as.integer(rownames(.))) %>%
  left_join(clinicaldata_3) %>%
  mutate(Gensini_bin = as.character(Gensini_bin))
```

```{r}
stats_test <- sig_features_test %>% 
  group_by(Gensini_bin) %>%
  dplyr::select(coefs_sub$feature) %>%
  # dplyr::select(-sample_id) %>%
  as.data.frame() %>%
  melt() %>%
  mutate(feature = variable) %>%
  group_by(feature) %>%
  t_test(value ~ Gensini_bin) %>%
  adjust_pvalue(method = "bonferroni") %>%
  add_significance("p.adj") %>%
  add_xy_position(x = 1, dodge = 0.0)   %>%
  filter(p.adj < 0.05)
```

```{r}
if(nrow(stats_test) > 0 ){
  sig_features_test %>% 
  group_by(Gensini_bin) %>%
  dplyr::select(stats_test$feature) %>%
  # dplyr::select(-sample_id) %>%
  as.data.frame() %>%
  melt() %>%
  mutate(feature = variable) %>%
  ggboxplot(x = 'Gensini_bin', y = 'value',
            color = 'Gensini_bin', palette = 'jco',
            facet.by = 'feature', scale = 'free_y') +
  labs(title = "") +
    theme_minimal() + 
    theme_bw() +
    theme(axis.text.x = element_text(size = 16),
          plot.title = element_text(size = 20, hjust = 0.5),
          axis.text.y = element_text(size = 16),
          axis.title.y = element_text(size = 16),
          axis.title.x = element_text(size = 16),
          legend.text = element_text(size = 16),
          legend.title = element_text(size = 16),
          legend.position = 'None',
          strip.text.x = element_text(size = 16, colour = "black", face = 'bold')
    ) + stat_pvalue_manual(
  stats_test,  label = "p.adj.signif", tip.length = 0,
  size = 6, color = 'red'
  ) + scale_y_continuous(expand = expansion(mult = c(0, 0.1)))
}

```

# look at logit proportions
```{r}
coefs <- coef(fit) %>%
  as.matrix() %>%
  as.data.frame()
coefs$feature <- rownames(coefs) %>%
  janitor::make_clean_names()

coefs_logit <- coefs %>%
  filter(feature %like% 'logit') %>%
  filter(V1 != 0)
```

```{r}
colnames(data_logit) <- janitor::make_clean_names(colnames(data_logit))
sig_features_logit <- data_logit %>%
  dplyr::select(coefs_logit$feature) %>%
  mutate(sample_id = as.integer(rownames(.))) %>%
  left_join(clinicaldata)
```

```{r}
stats_logit <- sig_features_logit %>% 
  group_by(Gensini_bin) %>%
  dplyr::select(coefs_logit$feature) %>%
  # dplyr::select(-sample_id) %>%
  as.data.frame() %>%
  melt() %>%
  mutate(feature = variable) %>%
  group_by(feature) %>%
  t_test(value ~ Gensini_bin) %>%
  adjust_pvalue(method = "bonferroni") %>%
  add_significance("p.adj") %>%
  add_xy_position(x = 1, dodge = 0.0)
```

```{r}
sig_features_logit %>% 
  group_by(Gensini_bin) %>%
  dplyr::select(coefs_logit$feature) %>%
  # dplyr::select(-sample_id) %>%
  as.data.frame() %>%
  melt() %>%
  mutate(feature = variable) %>%
  ggboxplot(x = 'Gensini_bin', y = 'value',
            color = 'Gensini_bin', palette = 'jco',
            facet.by = 'feature', scale = 'free_y') +
  labs(title = "") +
    theme_minimal() + 
    theme_bw() +
    theme(axis.text.x = element_text(size = 16),
          plot.title = element_text(size = 20, hjust = 0.5),
          axis.text.y = element_text(size = 16),
          axis.title.y = element_text(size = 16),
          axis.title.x = element_text(size = 16),
          legend.text = element_text(size = 16),
          legend.title = element_text(size = 16),
          legend.position = 'None',
          strip.text.x = element_text(size = 16, colour = "black", face = 'bold')
    ) + stat_pvalue_manual(
  stats_logit,  label = "p.adj.signif", tip.length = 0,
  size = 6, color = 'red'
  ) + scale_y_continuous(expand = expansion(mult = c(0, 0.1)))
```


```{r}
colnames(data_3_logit) <- janitor::make_clean_names(colnames(data_3_logit))
sig_features_logit_test <- data_3_logit %>%
  dplyr::select(coefs_logit$feature) %>%
  mutate(sample_id = as.integer(rownames(.))) %>%
  left_join(clinicaldata_3) %>%
  mutate(Gensini_bin = as.character(Gensini_bin))
```

```{r}
stats_logit_test <- sig_features_logit_test %>% 
  group_by(Gensini_bin) %>%
  dplyr::select(coefs_logit$feature) %>%
  # dplyr::select(-sample_id) %>%
  as.data.frame() %>%
  melt() %>%
  mutate(feature = variable) %>%
  group_by(feature) %>%
  t_test(value ~ Gensini_bin) %>%
  adjust_pvalue(method = "bonferroni") %>%
  add_significance("p.adj") %>%
  add_xy_position(x = 1, dodge = 0.0)
```

```{r}
sig_features_logit_test %>% 
  group_by(Gensini_bin) %>%
  dplyr::select(coefs_logit$feature) %>%
  # dplyr::select(-sample_id) %>%
  as.data.frame() %>%
  melt() %>%
  mutate(feature = variable) %>%
  ggboxplot(x = 'Gensini_bin', y = 'value',
            color = 'Gensini_bin', palette = 'jco',
            facet.by = 'feature', scale = 'free_y') +
  labs(title = "Study 3") +
    theme_minimal() + 
    theme_bw() +
    theme(axis.text.x = element_text(size = 16),
          plot.title = element_text(size = 20, hjust = 0.5),
          axis.text.y = element_text(size = 16),
          axis.title.y = element_text(size = 16),
          axis.title.x = element_text(size = 16),
          legend.text = element_text(size = 16),
          legend.title = element_text(size = 16),
          legend.position = 'None',
          strip.text.x = element_text(size = 16, colour = "black", face = 'bold')
    ) + stat_pvalue_manual(
  stats_logit_test,  label = "p.adj.signif", tip.length = 0,
  size = 6, color = 'red'
  ) + scale_y_continuous(expand = expansion(mult = c(0, 0.1)))
```

# Save SCE objects
```{r, eval=F}
save(sce_norm, file = "../sce_dat/study_4_autoEncoder_MG_sce.RData")
save(sce_3_norm, file = "../sce_dat/study_3_autoEncoder_MG_sce.RData")
```
