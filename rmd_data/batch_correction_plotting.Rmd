---
title: "Plot batch correction results"
author: "Elijah WIllie"
date: "2024-03-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = TRUE) 
knitr::opts_chunk$set(fig.width=10, fig.height=6) 
```

```{r}
rm(list = ls())
gc()
suppressPackageStartupMessages({
  library(tidyverse)
  library(ggsci)
  library(data.table)
  library(zoo)
})
```

# AUCs
## Read in the auc data
```{r}
# deep learning
aucs_dl <- read.csv('../auc_data/deeplasso_study_4_auc.csv') %>% 
  rollapply(10, mean, by = 10, align = "left", partial = TRUE) %>%
  as.data.frame()
# cyCombine
aucs_cyCombine <- read.csv('../auc_data/cyCombine_study_4_auc.csv') %>% 
  rollapply(10, mean, by = 10, align = "left", partial = TRUE) %>%
  as.data.frame()
# scMerge2
aucs_scMerge2 <- read.csv('../auc_data/scMerge2_study_4_auc.csv') %>% 
  rollapply(10, mean, by = 10, align = "left", partial = TRUE) %>%
  as.data.frame()
# iMUBAC
aucs_imubac <- read.csv('../auc_data/iMUBAC_study_4_auc.csv') %>% 
  rollapply(10, mean, by = 10, align = "left", partial = TRUE) %>%
  as.data.frame()
```

## Combine the AUCs data and format it for plotting
```{r}
aucs_all <- cbind(aucs_dl, aucs_cyCombine, aucs_scMerge2, aucs_imubac)

# melt all aucs
aucs_all_melted <- data.table::melt(aucs_all)
colnames(aucs_all_melted) <- c('Method', 'AUC')

aucs_all_melted$Method <- aucs_all_melted$Method %>%
  recode('DeepLasso' = 'Deep Lasso')
```
## Plot AUCs
```{r, fig.height=6, fig.width=8}
pdf(file = "../Plots/batch_correction_aucs_plot.pdf",   # The directory you want to save the file in
    width = 8, # The width of the plot in inches
    height = 6) # The height of the plot in inches

ggplot(aucs_all_melted, aes(x = Method, y = AUC, fill = Method)) +
  geom_boxplot(size = 1) +
  theme_bw() + ggtitle("Study 4: 10-fold CV with 10 repeats") +
  ylab("AUC") +
  theme(
      plot.title = element_text(color="Black", size=18, face="bold", hjust = 0.5),
      plot.subtitle = element_text(color = "red", size = 18, hjust = 0.5),
      axis.title.x = element_text(color="Black", size=18),
      axis.title.y = element_text(color="Black", size=18),
      axis.text.y = element_text(size = 18),
      axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 18),
      strip.text.x = element_text(size = 18),
      legend.title = element_text(size=18), #change legend title font size
      legend.text = element_text(size=18) #change legend text font size)
    ) + scale_fill_startrek()

dev.off()
```
# Concordance plots
## read in the concordance data
```{r}
# deep learning
con_dl <- read.csv('../concordance_data/deep_learning_concordance_30_clusters.csv')
# cyCombine
con_cyCombine <- read.csv('../concordance_data/cyCombine_concordance_30_clusters.csv')
# scMerge2
con_scMerge2 <- read.csv('../concordance_data/scMerge2_concordance_30_clusters.csv')
# iMUBAC
con_imubac <- read.csv('../concordance_data/imubac_concordance_30_clusters.csv')
```

## Combine the concordance data and format it for plotting
```{r}
con_all <- rbind(con_dl, con_cyCombine, con_scMerge2, con_imubac)

# melt all con
con_all_melted <- data.table::melt(con_all)
colnames(con_all_melted) <- c('Method', 'Metric', 'Score')
```

## Plot Concordance
```{r, fig.height=6, fig.width=8}
pdf(file = "../Plots/batch_correction_concordance_plot.pdf",   # The directory you want to save the file in
    width = 8, # The width of the plot in inches
    height = 6) # The height of the plot in inches

ggplot(con_all_melted, aes(x = Method, y = Score, fill = Method)) +
  geom_bar(stat = 'identity') +
  facet_wrap(~Metric) +
  theme_bw() + ggtitle("All methods concordance") +
  ylab("Score") +
  theme(
      plot.title = element_text(color="Black", size=18, face="bold", hjust = 0.5),
      plot.subtitle = element_text(color = "red", size = 18, hjust = 0.5),
      axis.title.x = element_text(color="Black", size=18),
      axis.title.y = element_text(color="Black", size=18),
      axis.text.y = element_text(size = 18),
      axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 18),
      strip.text.x = element_text(size = 18),
      legend.title = element_text(size=18), #change legend title font size
      legend.text = element_text(size=18) #change legend text font size)
    ) + scale_fill_startrek()

dev.off()
```

# Per batch concordance
## read in the concordance data
```{r}
# deep learning
con_batch_dl <- read.csv('../concordance_data/deep_learning_all_batches.csv')
con_batch_dl$Method <- rep('DL', nrow(con_batch_dl))

con_batch_single_dl <- read.csv('../concordance_data/deep_learning_single_batches.csv')
con_batch_single_dl$Method <- rep('DL-Single', nrow(con_batch_single_dl))

# cyCombine
con_batch_cyCombine <- read.csv('../concordance_data/cyCombine_all_batches.csv')
con_batch_cyCombine$Method <- rep('cyCombine', nrow(con_batch_cyCombine))

# scMerge2
con_batch_scMerge2 <- read.csv('../concordance_data/scMerge2_all_batches.csv')
con_batch_scMerge2$Method <- rep('scMerge2', nrow(con_batch_scMerge2))

# iMUBAC
con_batch_imubac <- read.csv('../concordance_data/iMUBAC_all_batches.csv')
con_batch_imubac$Method <- rep('iMUBAC', nrow(con_batch_imubac))

con_batch_single_unnorm <- read.csv('../concordance_data/deep_learning_single_batches_unnorm.csv')
con_batch_single_unnorm$Method <- rep('Unnorm-Single', nrow(con_batch_single_unnorm))

con_batch_all_unnorm <- read.csv('../concordance_data/deep_learning_all_batches_unnorm.csv')
con_batch_all_unnorm$Method <- rep('Unnorm', nrow(con_batch_all_unnorm))
```

## Combine the concordance data and format it for plotting
```{r}
con_batch_all <- rbind(con_batch_dl, con_batch_cyCombine, con_batch_imubac,
                       con_batch_single_dl, con_batch_scMerge2, 
                       con_batch_single_unnorm, con_batch_all_unnorm)

# melt all con
con_batch_all_melted <- data.table::melt(con_batch_all)
colnames(con_batch_all_melted) <- c("Batch","Cluster","Method",
                                    "Metric","Score" )
```

# Separate based on clustering
```{r}
con_batch_all_melted_mg <- con_batch_all_melted[con_batch_all_melted$Cluster == 'MG', ]
con_batch_all_melted_fs <- con_batch_all_melted[con_batch_all_melted$Cluster == 'FuseSOM', ]
```

## plot results for MG
```{r, fig.height=6, fig.width=10}
ggplot(con_batch_all_melted_mg, 
       aes(x = Method, y = Score, fill = Method)) +
  geom_boxplot() +
  facet_grid(~Metric, scales = 'free_y') +
  theme_bw() + ggtitle("All methods for manually gated clusters") +
  ylab("Score") +
  theme(
      plot.title = element_text(color="Black", size=18, face="bold", hjust = 0.5),
      plot.subtitle = element_text(color = "red", size = 18, hjust = 0.5),
      axis.title.x = element_text(color="Black", size=18),
      axis.title.y = element_text(color="Black", size=18),
      axis.text.y = element_text(size = 18),
      axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 18),
      strip.text.x = element_text(size = 18),
      legend.title = element_text(size=18), #change legend title font size
      legend.text = element_text(size=18) #change legend text font size)
    ) + scale_fill_startrek()
```

## plot results for FuseSOM 
```{r, fig.height=6, fig.width=10}
ggplot(con_batch_all_melted_fs, 
       aes(x = Method, y = Score, fill = Method)) +
  geom_boxplot() +
  facet_grid(~Metric, scales = 'free_y') +
  theme_bw() + ggtitle("All methods for FuseSOM clusters") +
  ylab("Score") +
  theme(
      plot.title = element_text(color="Black", size=18, face="bold", hjust = 0.5),
      plot.subtitle = element_text(color = "red", size = 18, hjust = 0.5),
      axis.title.x = element_text(color="Black", size=18),
      axis.title.y = element_text(color="Black", size=18),
      axis.text.y = element_text(size = 18),
      axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 18),
      strip.text.x = element_text(size = 18),
      legend.title = element_text(size=18), #change legend title font size
      legend.text = element_text(size=18) #change legend text font size)
    ) + scale_fill_startrek()
```

# Per batch concordance
## read in the concordance data
```{r}
# deep learning
con_batch_dl <- read.csv('../concordance_data/deep_learning_pairwise_batches.csv')
con_batch_dl$Method <- rep('DL', nrow(con_batch_dl))

con_batch_unnorm <- read.csv('../concordance_data/deep_learning_pairwise_batches_unnorm.csv')
con_batch_unnorm$Method <- rep('Unnorm', nrow(con_batch_unnorm))
```

## Combine the concordance data and format it for plotting
```{r}
con_batch_all <- rbind(con_batch_dl, con_batch_unnorm)

# melt all con
con_batch_all_melted <- data.table::melt(con_batch_all)
colnames(con_batch_all_melted) <- c("Train","Test","Cluster","Method",
                                    "Metric","Score" )
```

## plot results for MG
```{r, fig.height=6, fig.width=10}
ggplot(con_batch_all_melted, 
       aes(x = Method, y = Score, fill = Method)) +
  geom_boxplot() +
  facet_grid(~Metric, scales = 'free_y') +
  theme_bw() + ggtitle("Pairwise batch prediction") +
  ylab("Score") +
  theme(
      plot.title = element_text(color="Black", size=18, face="bold", hjust = 0.5),
      plot.subtitle = element_text(color = "red", size = 18, hjust = 0.5),
      axis.title.x = element_text(color="Black", size=18),
      axis.title.y = element_text(color="Black", size=18),
      axis.text.y = element_text(size = 18),
      axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 18),
      strip.text.x = element_text(size = 18),
      legend.title = element_text(size=18), #change legend title font size
      legend.text = element_text(size=18) #change legend text font size)
    ) + scale_fill_startrek()
```