---
title: "Bioheart Deep Learning"
author: "Elijah WIllie"
date: "2023-12-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = TRUE) 
knitr::opts_chunk$set(fig.width=10, fig.height=6) 
```

```{r}
rm(list = ls())
gc()
suppressPackageStartupMessages({
  library(reticulate)
  library(keras)
  library(tidyverse)
  library(FuseSOM)
  library(ggsci)
  library(uwot)
  library(data.table)
  library(SingleCellExperiment)
  library(SKM)
  library(caret)
  library(ROCR)
  library(cvAUC)
  library(spicyR)
  library(cyCombine)
  library(ClassifyR)
  library(cowplot)
  library(psych)
  library(igraph)
  library(tensorflow)
  library(Spectrum)
  library(glmnet)
  library(ipflasso)
  library(prioritylasso)
  library(hopach)
  library(rpart)
  library(rpart.plot)
  # library(ruta)
  library(ggtree)
  library(ape)
  library(grpregOverlap)
  library(ggiraph)
  library(scales)
  library(ggnewscale)
})

k = backend()     # this where the software used to break
source('~/Documents/PhD/bioheart_analysis/scripts/autoClass.R')
source('~/Documents/PhD/bioheart_analysis/scripts/helperFuncs.R')
source('~/Documents/PhD/bioheart_analysis/scripts/customCV.R')
source('~/Documents/PhD/bioheart_analysis/scripts/predClusters.R')
source('~/Documents/PhD/bioheart_analysis/scripts/trainClassifier.R')
# source('~/Documents/PhD/DeepLearning_CyTOF/robust_ae.R')
```

# load both studies
```{r}
nCores <- 4
BPPARAM <- simpleSeg:::generateBPParam(nCores)
theme_set(theme_classic())
```

# Set the markers
```{r}
useMarkers <- c('HLA_DR', 'CD3', 'CD4', 'CD8a', 'CD25', 'CD127', 'FoxP3', 'CD27',
                'KLRG1', 'CD56', 'CD45RO', 'CD45RA', 'CD192_CCR2', 'CD194_CCR4',
                'CD196_CCR6',
                'CD39', 'CD38', 'Ki67', 'CD183_CXCR3', 'CCR7', 'CD19', 'CD20',
                'IgD', 'CD14', 'CD304', 'CD141', 'CD1c_PE')

allMarkers <- c('HLA_DR', 'CD3', 'CD4', 'CD8a', 'CD25', 'CD127', 'FoxP3', 'CD27',
                'KLRG1', 'CD56', 'CD45RO', 'CD45RA', 'CD192_CCR2', 'CD194_CCR4',
                'CD196_CCR6',
                'CD39', 'CD38', 'Ki67', 'CD183_CXCR3', 'CCR7', 'CD19', 'CD20',
                'IgD', 'CD14', 'CD304', 'CD141', 'CD1c_PE', "CD11b", "CD253_TRAIL",
                "CD34", "CD61", "CD11c", "eNOS", "LOX_1", "CD86", "CD16", "CD45_106",
                "CD45_108", "P2X7", "NOX5")
```

# Read in the dataset
## Study 4
```{r}
# study 4
set.seed(1994)
df <- fread('../raw_data/bioheart_ct_cytof_data_b4_mg.csv',
              nThread = 7) %>%
  as.data.frame() 

# %>%
#   group_by(sample_id) %>%
#   slice_sample(n = 5000) 

df <- df[which(df$mg_cell_type_distinct != ""), ]
# df <- df[which(df$mg_cell_type_distinct != "other"), ]

df[, useMarkers] <- log(abs(df[, useMarkers]) + 1)

# 
preProcValues <- preProcess(df[, useMarkers], method = c("range"))
# 
df[, useMarkers] <- predict(preProcValues, df[, useMarkers])

```

## Study 3
```{r}
df_3 <- fread('../raw_data/study_3_sub.csv',
              nThread = 7) %>% 
  as.data.frame() 

# %>%
#   group_by(sample_id)

df_3[, useMarkers] <- log(abs(df_3[, useMarkers]) + 1) 

df_3[, useMarkers] <- predict(preProcValues, df_3[, useMarkers])
```

## Study 5
```{r, eval=F}
df_5 <- fread('raw_data/study_5_sub.csv',
              nThread = 7) %>% 
  as.data.frame() 

names(df_5)[names(df_5) == 'CD197_CCR7'] <- 'CCR7'

df_5[, useMarkers] <- log(abs(df_5[, useMarkers]) + 1)

df_5[, useMarkers] <- predict(preProcValues, df_5[, useMarkers])
```

# Get the reference sample for training
```{r}
res_ind <- ComputeReferenceSample(df, useMarkers)
```

# Get the encoding dimensions and the number of clusters 
```{r}
train_dat <- df[which(df$sample_id == res_ind$refSampleInd), useMarkers]
# train_dat <- df %>%
#   group_by(sample_id) %>%
#   slice_sample(n = 1000)
encoding_dim <- FuseSOM::computeGridSize(train_dat[, useMarkers])
```


# Define autoencoder model
```{r}
models <- autoEncoderModel(train_dat = train_dat, input_size = length(useMarkers),
                           encoding_dim = encoding_dim*2, l1_reg = 0)

# model  <- robust_ae(train_dat[, useMarkers], encoding_dim = encoding_dim*2, batch_size = 16, epochs = 100)
```

# Predict on study 4
```{r}
df_norm <- predict(models$autoencoder_model, as.matrix(df[, useMarkers])) %>%
  as.data.frame()

# df_norm <- model |> reconstruct(df[, useMarkers]) %>%
#   as.data.frame()
colnames(df_norm) <- useMarkers

# df_latent <- predict(models$encoder_model, as.matrix(df[, useMarkers])) %>%
#   as.data.frame()
```
# Predict on study 3
```{r}
df_3_norm <- predict(models$autoencoder_model, as.matrix(df_3[, useMarkers])) %>%
  as.data.frame()
colnames(df_3_norm) <- useMarkers

# df_3_latent <- predict(models$encoder_model, as.matrix(df_3[, useMarkers])) %>%
#   as.data.frame()
```
# Predict on study 5
```{r, eval=FALSE}
df_5_norm <- predict(models$autoencoder_model, as.matrix(df_5[, useMarkers]))%>%
  as.data.frame()
colnames(df_5_norm) <- useMarkers
```


# Create SCE object for study 4 and cluster it
```{r}
# df_norm <- df_norm %>%
#   as.data.frame()
sce_norm <- SingleCellExperiment(assays = list(norm = t(df_norm[, useMarkers]),
                                               raw = t(df[, useMarkers])
),
colData = df %>% dplyr::select(-useMarkers))
# sce_norm$clusters <- y_pred
```

```{r}
# dim <- dancoDimEst(as.matrix(df_norm),8,20)
```


## Use FuseSOM to cluster the normalised data
```{r}
# run FuseSOM clustering
nclust = 12
sce_norm <- runFuseSOM(sce_norm, numClusters = nclust, assay = 'norm',
                       verbose = FALSE)
# sce_norm$clusters <- sce_temp$clusters
```


```{r}
scater::plotGroupedHeatmap(sce_norm, 
                           features = useMarkers, 
                           group = "clusters", 
                           block = "clusters",
                           exprs_values = "norm",
                           center = TRUE, 
                           scale = TRUE, 
                           zlim = c(-3,3),
                           cluster_rows = FALSE)
```

```{r}
aricode::ARI(sce_norm$clusters, sce_norm$mg_cell_type_distinct)
```

```{r}
aricode::NMI(sce_norm$clusters, sce_norm$mg_cell_type_distinct)
```

```{r, eval=T}
set.seed(1994)
sample_pts <- sample(nrow(df), 100000)
sce_sub <- sce_norm[, sample_pts]

sce_sub <- scater::runUMAP(sce_sub,
                         subset_row = useMarkers,
                         exprs_values = "raw",
                         BPPARAM = BPPARAM, 
                         n_threads = 7,
                         metric = 'cosine',
                         verbose = T)

df_raw_umap <- reducedDim(sce_sub, 'UMAP') %>%
    as.data.frame()
colnames(df_raw_umap) <- c('UMAP 1', 'UMAP 2')

df_raw_umap$Batch <- sce_sub$CyTOF.Batch

# df_raw_umap$Study <- if_else(df_raw_umap$batch %like% '3', '3', '4')
```


```{r, eval=T}
sce_sub <- scater::runUMAP(sce_sub,
                         subset_row = useMarkers,
                         exprs_values = "norm",
                         BPPARAM = BPPARAM, 
                         n_threads = 7,
                         metric = 'cosine',
                         verbose = T)

df_norm_umap <- reducedDim(sce_sub, 'UMAP') %>%
    as.data.frame()
colnames(df_norm_umap) <- c('UMAP 1', 'UMAP 2')

df_norm_umap$Batch <- sce_sub$CyTOF.Batch

# df_corrected_umap$Study <- if_else(df_raw_umap$Batch %like% '3', '3', '4')
```

```{r, eval=T}
p.raw.umap <- df_raw_umap %>% ggplot(aes(`UMAP 1`, `UMAP 2`)) +
    geom_point(aes(color = `Batch`), size = 1) + 
    ggtitle('UMAP plot of raw data - Study 4') +
  theme_bw() + 
    theme(axis.text.x = element_text(size = 12),
        plot.title = element_text(size = 15, hjust = 0.5),
        axis.text.y = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12)
        ) + scale_color_d3(palette = 'category20')
```

```{r, eval=T}
p.norm.umap <- df_norm_umap %>% ggplot(aes(`UMAP 1`, `UMAP 2`)) +
    geom_point(aes(color = `Batch`), size = 1) + 
    ggtitle('UMAP plot of normalised data - Study 4') +
  theme_bw() + 
    theme(axis.text.x = element_text(size = 12),
        plot.title = element_text(size = 15, hjust = 0.5),
        axis.text.y = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12)
        ) + scale_color_d3(palette = 'category20')
```

```{r, eval=T}
cowplot::plot_grid(p.raw.umap, p.norm.umap)
```


```{r}
# do prediction
data <- getProp(sce_norm,
                feature = "clusters", imageID = "sample_id", logit = F)

dat_prop <- data
data <- 2*asin(sqrt(data))

clinicaldata <- colData(sce_norm) %>%
  as.data.frame() %>%
  dplyr::select(sample_id, Gensini, Gender, Age) %>%
  distinct()
clinicaldata$Gensini_bin <- factor(if_else(clinicaldata$Gensini > 0, 1, 0))

encoded_gender <- model.matrix(~Gender-1, data=clinicaldata)
clinicaldata <- cbind(clinicaldata, encoded_gender)

row_names <- rownames(data)

Age <- clinicaldata[match(row_names,clinicaldata$sample_id),
                                      "Age"]
GenderM <- clinicaldata[match(row_names,clinicaldata$sample_id),
                                      c("GenderM")]

clinicaldata_info <- cbind(Age, GenderM)

condition <- factor(clinicaldata[match(row_names,clinicaldata$sample_id),
                                      "Gensini_bin"])


data_logit <- getProp(sce_norm,
                feature = "clusters", imageID = "sample_id", logit = T)
colnames(data_logit) <- paste0(colnames(data_logit), "_logit")
colnames(data) <- paste0(colnames(data), "_prop")
colnames(dat_prop) <- colnames(data)
```


```{r}
t <- df_norm
t$sample_id <- df$sample_id

data_mean <- t %>% 
  dplyr::group_by(sample_id) %>%
  dplyr::summarise_at(vars(useMarkers), mean) %>%
  dplyr::select(-sample_id) %>%
  as.data.frame()

data_median <- t %>% 
  group_by(sample_id) %>%
  summarise_at(vars(useMarkers), median) %>%
  dplyr::select(-sample_id) %>%
  as.data.frame()

rownames(data_mean) <- clinicaldata$sample_id
rownames(data_median) <- clinicaldata$sample_id
colnames(data_mean) <- paste0(colnames(data_mean), "_mean")
colnames(data_median) <- paste0(colnames(data_median), "_median")
```


```{r}
res.cv <- KFoldCustomEnsemble(dat_prop = data, dat_logit = data_logit, 
                              dat_mean = data_mean,
                              train_y = condition, 
                              nRepeats = 10, k = 10, alpha = 0.05)
```

```{r}
# aucs <- data.frame(DeepLasso = res.cv$cv_res)
# write.csv(aucs, file = '../DeepLearning_CyTOF/Bioheart_study_4/Bioheart_study_4_deeplasso.csv', row.names = F)
```


# Train clustering model with scCLassify
## Select training data 
```{r}
set.seed(1994)
# df_norm <- df_norm
# df_norm$clusters_mg <- factor(sce_norm$mg_cell_type_distinct)
df_norm$clusters_fs <- factor(sce_norm$clusters)
df_norm$sample_id <- sce_norm$sample_id

df_norm_sub <- df_norm[which(df$sample_id == res_ind$refSampleInd), ]
```

## Fit SKM neural net model
```{r}
nnet_model <- SKM::deep_learning(
  y = df_norm_sub$clusters_fs,
  x =  as.matrix(df_norm_sub[, useMarkers]),
  epochs_number = 100,
  layers = list(list(neurons_number = 27, 
                      neurons_proportion = NULL, 
                       activation = "relu")),
  optimizer = 'adam', seed = 1994, 
  loss_function = 'categorical_crossentropy', 
  batch_size = 16, learning_rate = 0.005,
  verbose = TRUE
)
```

## Now preedict on study 3
```{r}
df_3_clusters <- nnet_model %>%
    predict(as.matrix(df_3_norm))
df_3_clusters <- df_3_clusters$predicted
```

## Compute features on study 3
### Generate SCE object and populate clusters
```{r}
sce_3_norm <- SingleCellExperiment(assays = list(raw = t(df_3[,useMarkers]),
                                                 norm = t(df_3_norm[, useMarkers])
                                          ),
                                 colData = df_3[, 1:10])

sce_3_norm$fs_cluster <- df_3_clusters
```

### Generate heatmaps
```{r}
scater::plotGroupedHeatmap(sce_3_norm, 
                           features = useMarkers, 
                           group = "fs_cluster", 
                           block = "fs_cluster",
                           exprs_values = "norm",
                           center = TRUE, 
                           scale = TRUE, 
                           zlim = c(-3,3),
                           cluster_rows = FALSE)
```

```{r, eval=T}
set.seed(1994)
sample_pts_3 <- sample(nrow(df_3), 100000)
sce_sub_3 <- sce_3_norm[, sample_pts_3]

sce_sub_3 <- scater::runUMAP(sce_sub_3,
                         subset_row = useMarkers,
                         exprs_values = "raw",
                         BPPARAM = BPPARAM, 
                         n_threads = 7,
                         metric = 'cosine',
                         verbose = T)

df_3_raw_umap <- reducedDim(sce_sub_3, 'UMAP') %>%
    as.data.frame()
colnames(df_3_raw_umap) <- c('UMAP 1', 'UMAP 2')

df_3_raw_umap$Batch <- sce_sub_3$CyTOF.Batch

# df_raw_umap$Study <- if_else(df_raw_umap$batch %like% '3', '3', '4')
```


```{r, eval=T}
sce_sub_3 <- scater::runUMAP(sce_sub_3,
                         subset_row = useMarkers,
                         exprs_values = "norm",
                         BPPARAM = BPPARAM, 
                         n_threads = 7,
                         metric = 'cosine',
                         verbose = T)

df_3_norm_umap <- reducedDim(sce_sub_3, 'UMAP') %>%
    as.data.frame()
colnames(df_3_norm_umap) <- c('UMAP 1', 'UMAP 2')

df_3_norm_umap$Batch <- sce_sub_3$CyTOF.Batch

# df_corrected_umap$Study <- if_else(df_raw_umap$Batch %like% '3', '3', '4')
```

```{r, eval=T}
p.raw.3.umap <- df_3_raw_umap %>% ggplot(aes(`UMAP 1`, `UMAP 2`)) +
    geom_point(aes(color = `Batch`), size = 1) + 
    ggtitle('UMAP plot of raw data - Study 3') +
  theme_bw() + 
    theme(axis.text.x = element_text(size = 12),
        plot.title = element_text(size = 15, hjust = 0.5),
        axis.text.y = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12)
        ) + scale_color_d3(palette = 'category20')
```

```{r, eval=T}
p.norm.3.umap <- df_3_norm_umap %>% ggplot(aes(`UMAP 1`, `UMAP 2`)) +
    geom_point(aes(color = `Batch`), size = 1) + 
    ggtitle('UMAP plot of normalised data - Study 3') +
  theme_bw() + 
    theme(axis.text.x = element_text(size = 12),
        plot.title = element_text(size = 15, hjust = 0.5),
        axis.text.y = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12)
        ) + scale_color_d3(palette = 'category20')
```

```{r, eval=T}
cowplot::plot_grid(p.raw.3.umap, p.norm.3.umap)
```

## Generate features
```{r}
data_3 <- getProp(sce_3_norm,
                feature = "fs_cluster", imageID = "sample_id", logit = F)


data_3 <- 2*asin(sqrt(data_3))
# 
# data_3_2 <- getProp(sce_3_norm,
#                   feature = "clusters", imageID = "sample_id", logit = T)
# data_3 <- cbind(data_3, data_3_2)
colnames(data_3) <- janitor::make_clean_names(colnames(data_3))

clinicaldata_3 <- colData(sce_3_norm) %>%
  as.data.frame() %>%
  dplyr::select(sample_id, Gensini, Age, Gender) %>%
  distinct()
clinicaldata_3$Gensini_bin <- factor(if_else(clinicaldata_3$Gensini > 0, 1, 0))
encoded_gender_3 <- model.matrix(~Gender-1, data=clinicaldata_3)
clinicaldata_3 <- cbind(clinicaldata_3, encoded_gender_3)

row_names_3 <- rownames(data_3)

Age <- clinicaldata_3[match(row_names_3,clinicaldata_3$sample_id),
                                      "Age"]
GenderM <- clinicaldata_3[match(row_names_3,clinicaldata_3$sample_id),
                                      c("GenderM")]

clinicaldata_info_3 <- cbind(Age, GenderM)

data_3_logit <- getProp(sce_3_norm,
                feature = "fs_cluster", imageID = "sample_id", logit = T)

condition_3 <- factor(clinicaldata_3[match(row_names_3,clinicaldata_3$sample_id),
                                      "Gensini_bin"])

colnames(data_3_logit) <- paste0(colnames(data_3_logit), "_logit")
colnames(data_3) <- paste0(colnames(data_3), "_prop")
```

```{r}
data_ratio_3 <- calculate_ratios(data_3)
```

```{r}
t_3 <- df_3_norm
t_3$sample_id <- df_3$sample_id

t_3_mean <- t_3 %>% 
  group_by(sample_id) %>%
  summarise_at(vars(useMarkers), mean) %>%
  dplyr::select(-sample_id) %>%
  as.data.frame()

t_3_median <- t_3 %>% 
  group_by(sample_id) %>%
  summarise_at(vars(useMarkers), median) %>%
  dplyr::select(-sample_id) %>%
  as.data.frame()

rownames(t_3_mean) <- clinicaldata_3$sample_id
rownames(t_3_median) <- clinicaldata_3$sample_id

colnames(t_3_mean) <- paste0(colnames(t_3_mean), "_mean")
colnames(t_3_median) <- paste0(colnames(t_3_median), "_median")
```


## Now preedict on study 5
```{r}
df_5_clusters <- nnet_model %>%
    predict(as.matrix(df_5_norm))
df_5_clusters <- df_5_clusters$predicted
```

## Compute features on study 3
### Generate SCE object and populate clusters
```{r}
sce_5_norm <- SingleCellExperiment(assays = list(raw = t(df_5[, useMarkers]),
                                                 norm = t(df_5_norm[, useMarkers])
                                          ),
                                 colData = df_5[, 1:10])

sce_5_norm$fs_cluster <- df_5_clusters
```

### Generate heatmaps
```{r}
scater::plotGroupedHeatmap(sce_5_norm, 
                           features = useMarkers, 
                           group = "fs_cluster", 
                           block = "fs_cluster",
                           exprs_values = "norm",
                           center = TRUE, 
                           scale = TRUE, 
                           zlim = c(-3,3),
                           cluster_rows = FALSE)
```

```{r, eval=T}
set.seed(1994)
sample_pts_5 <- sample(nrow(df_5), 100000)
sce_sub_5 <- sce_5_norm[, sample_pts_5]

sce_sub_5 <- scater::runUMAP(sce_sub_5,
                         subset_row = useMarkers,
                         exprs_values = "raw",
                         BPPARAM = BPPARAM, 
                         n_threads = 7,
                         metric = 'cosine',
                         verbose = T)

df_5_raw_umap <- reducedDim(sce_sub_5, 'UMAP') %>%
    as.data.frame()
colnames(df_5_raw_umap) <- c('UMAP 1', 'UMAP 2')

df_5_raw_umap$Batch <- as.factor(sce_sub_5$CyTOF.Batch.x)

# df_raw_umap$Study <- if_else(df_raw_umap$batch %like% '5', '5', '4')
```


```{r, eval=T}
sce_sub_5 <- scater::runUMAP(sce_sub_5,
                         subset_row = useMarkers,
                         exprs_values = "norm",
                         BPPARAM = BPPARAM, 
                         n_threads = 7,
                         metric = 'cosine',
                         verbose = T)

df_5_norm_umap <- reducedDim(sce_sub_5, 'UMAP') %>%
    as.data.frame()
colnames(df_5_norm_umap) <- c('UMAP 1', 'UMAP 2')

df_5_norm_umap$Batch <- as.factor(sce_sub_5$CyTOF.Batch.x)

# df_corrected_umap$Study <- if_else(df_raw_umap$Batch %like% '5', '5', '4')
```

```{r, eval=T}
p.raw.5.umap <- df_5_raw_umap %>% ggplot(aes(`UMAP 1`, `UMAP 2`)) +
    geom_point(aes(color = `Batch`), size = 1) + 
    ggtitle('UMAP plot of raw data - Study 5') +
  theme_bw() + 
    theme(axis.text.x = element_text(size = 12),
        plot.title = element_text(size = 15, hjust = 0.5),
        axis.text.y = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12)
        ) + scale_color_d3(palette = 'category20')
```

```{r, eval=T}
p.norm.5.umap <- df_5_norm_umap %>% ggplot(aes(`UMAP 1`, `UMAP 2`)) +
    geom_point(aes(color = `Batch`), size = 1) + 
    ggtitle('UMAP plot of normalised data - Study 5') +
  theme_bw() + 
    theme(axis.text.x = element_text(size = 12),
        plot.title = element_text(size = 15, hjust = 0.5),
        axis.text.y = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12)
        ) + scale_color_d3(palette = 'category20')
```

```{r, eval=T}
cowplot::plot_grid(p.raw.5.umap, p.norm.5.umap)
```

## Generate features
```{r}
data_5 <- getProp(sce_5_norm,
                feature = "fs_cluster", imageID = "sample_id", logit = F)


data_5 <- 2*asin(sqrt(data_5))
# 
# data_5_2 <- getProp(sce_5_norm,
#                   feature = "clusters", imageID = "sample_id", logit = T)
# data_5 <- cbind(data_5, data_5_2)
colnames(data_5) <- janitor::make_clean_names(colnames(data_5))

clinicaldata_5 <- colData(sce_5_norm) %>%
  as.data.frame() %>%
  dplyr::select(sample_id, Gensini, Age, Gender) %>%
  distinct()
clinicaldata_5$Gensini_bin <- factor(if_else(clinicaldata_5$Gensini > 0, 1, 0))
clinicaldata_5$Gender <- factor(if_else(clinicaldata_5$Gender == 1, 'M', 'F'))
encoded_gender_5 <- model.matrix(~Gender-1, data=clinicaldata_5)
clinicaldata_5 <- cbind(clinicaldata_5, encoded_gender_5)

row_names_5 <- rownames(data_5)

Age <- clinicaldata_5[match(row_names_5,clinicaldata_5$sample_id),
                                      "Age"]
GenderM <- clinicaldata_5[match(row_names_5,clinicaldata_5$sample_id),
                                      c("GenderM")]

clinicaldata_info_5 <- cbind(Age, GenderM)

data_5_logit <- getProp(sce_5_norm,
                feature = "fs_cluster", imageID = "sample_id", logit = T)

condition_5 <- factor(clinicaldata_5[match(row_names_5,clinicaldata_5$sample_id),
                                      "Gensini_bin"])

colnames(data_5_logit) <- paste0(colnames(data_5_logit), "_logit")
colnames(data_5) <- paste0(colnames(data_5), "_prop")

```


```{r}
t_5 <- df_5_norm
t_5$sample_id <- df_5$sample_id

t_5_mean <- t_5 %>% 
  group_by(sample_id) %>%
  summarise_at(vars(useMarkers), mean) %>%
  dplyr::select(-sample_id) %>%
  as.data.frame()

t_5_median <- t_5 %>% 
  group_by(sample_id) %>%
  summarise_at(vars(useMarkers), median) %>%
  dplyr::select(-sample_id) %>%
  as.data.frame()

rownames(t_5_mean) <- clinicaldata_5$sample_id
rownames(t_5_median) <- clinicaldata_5$sample_id

colnames(t_5_mean) <- paste0(colnames(t_5_mean), "_mean")
colnames(t_5_median) <- paste0(colnames(t_5_median), "_median")
```

```{r}
data_ratio_5 <- calculate_ratios(data_5)
```

```{r}
nclust <- length(unique(sce_norm$clusters))
overlapModel <- runOverlapLasso(data, data_logit, data_mean, nclust = nclust, alpha = 0.05)
fit <- overlapModel$fit
scaleVals <- overlapModel$scaling
```

```{r}
X_test_study_5 <- cbind(data_5, data_5_logit, t_5_mean)
colnames(X_test_study_5) <- janitor::make_clean_names(colnames(X_test_study_5))
X_test_study_5 <- predict(scaleVals, X_test_study_5) %>%
  as.matrix()


X_test_study_3 <- cbind(data_3, data_3_logit, t_3_mean)
colnames(X_test_study_3) <- janitor::make_clean_names(colnames(X_test_study_3))
X_test_study_3 <- predict(scaleVals, X_test_study_3) %>%
  as.matrix()
```

```{r}
pred_study_3 <- predict(fit, X = X_test_study_3,
                        type = "response")

pred_study_3 <- prediction(pred_study_3, condition_3)
pred_study_3_perf <- ROCR::performance(pred_study_3, "tpr", "fpr")


plt_dat_3 = data.frame(
  FPR = pred_study_3_perf@x.values[[1]],
  TPR = pred_study_3_perf@y.values[[1]]
)

auc_perf_study_3 <- ROCR::performance(pred_study_3, measure = "auc")
auc_study_3 <- auc_perf_study_3@y.values[[1]]

# generate AUC plot
p_auc_study_3 <- ggplot(plt_dat_3, aes(x = FPR, y = TPR)) +
  geom_line(colour = "blue") +
  labs(x = pred_study_3_perf@x.name, y = pred_study_3_perf@y.name) +
  geom_abline(slope = 1, intercept = 0) + theme_bw() +
  theme(
    plot.title = element_text(color="Black", size=16, face="bold", hjust = 0.5),
    plot.subtitle = element_text(color = "red", size = 16, hjust = 0.5),
    axis.title.x = element_text(color="Black", size=16),
    axis.title.y = element_text(color="Black", size=16),
    axis.text.y = element_text(size = 16),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 16),
    strip.text.x = element_text(size = 16),
    legend.title = element_text(size=16), #change legend title font size
    legend.text = element_text(size=16) #change legend text font size)
  )  + ggtitle(paste("Overlap Group - Study 3 - AUC =", round(auc_study_3, 2)))
```

```{r}
pred_study_5 <- predict(fit, X = X_test_study_5,
                        type = "response")

pred_study_5 <- prediction(pred_study_5, condition_5)
pred_study_5_perf <- ROCR::performance(pred_study_5, "tpr", "fpr")


plt_dat_5 = data.frame(
  FPR = pred_study_5_perf@x.values[[1]],
  TPR = pred_study_5_perf@y.values[[1]]
)

auc_perf_study_5 <- ROCR::performance(pred_study_5, measure = "auc")
auc_study_5 <- auc_perf_study_5@y.values[[1]]

# generate AUC plot
p_auc_study_5 <- ggplot(plt_dat_5, aes(x = FPR, y = TPR)) +
  geom_line(colour = "blue") +
  labs(x = pred_study_5_perf@x.name, y = pred_study_5_perf@y.name) +
  geom_abline(slope = 1, intercept = 0) + theme_bw() +
  theme(
    plot.title = element_text(color="Black", size=16, face="bold", hjust = 0.5),
    plot.subtitle = element_text(color = "red", size = 16, hjust = 0.5),
    axis.title.x = element_text(color="Black", size=16),
    axis.title.y = element_text(color="Black", size=16),
    axis.text.y = element_text(size = 16),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 16),
    strip.text.x = element_text(size = 16),
    legend.title = element_text(size=16), #change legend title font size
    legend.text = element_text(size=16) #change legend text font size)
  )  + ggtitle(paste("Overlap Group - Study 5 - AUC =", round(auc_study_5, 2)))
```

```{r, fig.height=6, fig.width=12}
cowplot::plot_grid(p_auc_study_3, p_auc_study_5)
```

```{r}
coefs <- coef(fit) %>%
  as.matrix() %>%
  as.data.frame()
coefs$feature <- rownames(coefs)
# coefs <- coefs[coefs$V1 != 0, ]
```

```{r}
res_mp <- MP_gLasso(fit = fit, group = fit$grp.vec, lambda.type = "min", sort.type = "max")
girafe(code = print(res_mp$plot), width_svg = 8, height_svg = 8)
```

```{r, fig.height=6, fig.width=12}
p <- plotOverlapTree(hc = overlapModel$hc_prop, coefs = coefs,
                     data = res_mp$data, heatmap = F)
p
```

