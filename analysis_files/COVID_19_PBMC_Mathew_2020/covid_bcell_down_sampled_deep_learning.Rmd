---
title: "Covid BCell Down Sampled Deep Learning"
author: "Elijah WIllie"
date: "2023-07-08"
output:
  html_document:
    toc: true
    code_folding: hide
    self_contained: yes
    theme: journal
    number_sections: no
    fig_width: 12
    fig_height: 8
    fontsize: 16pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = TRUE) 
knitr::opts_chunk$set(fig.width=10, fig.height=6) 
```


```{r}
rm(list = ls())
gc()
suppressPackageStartupMessages({
  library(keras3)
  library(reticulate)
  use_virtualenv('r-keras', required = TRUE)
  library(tensorflow)
  library(tidyverse)
  library(FuseSOM)
  library(ggsci)
  library(uwot)
  library(data.table)
  library(SingleCellExperiment)
  library(caret)
  library(ROCR)
  library(psych)
  library(tensorflow)
  library(glmnet)
  library(data.tree)
  library(ggtree)
  library(ape)
  library(grpregOverlap)
  library(ggiraph)
  library(scales)
  library(ggnewscale)
  library(rstatix)
  library(ggpubr)
})
source('~/Documents/PhD/bioheart_analysis/scripts/helperFuncs.R')
source('~/Documents/PhD/bioheart_analysis/scripts/vae_model.R')
source('~/Documents/PhD/bioheart_analysis/scripts/customCV.R')
source('~/Documents/PhD/bioheart_analysis/scripts/estimate.ED.R')
source('~/Documents/PhD/bioheart_analysis/scripts/deep_learning_helper_funcs.R')
set_random_seed(1994)

setwd('~/Documents/PhD/DeepLearning_CyTOF/COVID_19_PBMC_Mathew_2020/')
```

# Load in data and compute the reference sample
```{r}
load('~/Documents/PhD/DeepLearning_CyTOF/COVID_19_PBMC_Mathew_2020/data/raw/Bcell/Covid_Bcell_down_sampled.RData')

sce_sub <- sce[, which(sce$condition %in% c('COVID', 'HD'))]
metadata <- read.csv('../data/Covid_Bcell_metadata.csv')
metadata$time_days <- factor(metadata$time_days)

df <- cbind(data.frame(colData(sce_sub)), 
            data.frame(t(assay(sce_sub, 'counts')))) %>%
  left_join(metadata)

set.seed(1994)
df <- df %>%
  group_by(sample_id) %>%
  slice_sample(n=10000, replace = TRUE)

# CD45RA, PD-1, CXCR5, TCF-1, CD38, CD95, Eomes, CCR7, KI67, CD16, CD27, 
# CX3CR1, CD39, CD20, T-bet, and HLA-DR
useMarkers <- c("CD45RA.BUV395","PD.1.BV421","CXCR5.BB515","TCF.1.AF647", 
                "CD38.BUV661","CD39.APCFire750","CD95.BV650", "Eomes.PEef610",
                "CCR7.BB700", "Ki.67.AF700","CD16.BUV615", "CD27.BUV737",
                "CX3CR1.BB790", "CD20.BUV805", "T.bet.PE.Cy7", "HLA.DR.BV786")

# df$sample_id <- droplevels(df$sample_id)
# df$patient_id <- droplevels(df$patient_id)
```


```{r}
rm(sce)
rm(sce_sub)
gc()
```


# split into training and testing set
```{r}
# Now split the data into actual training and testing sets
train <- df %>%
  dplyr::filter(dataset == 'train') 

test <- df %>%
  dplyr::filter(dataset == 'test')
```

```{r}
# use a cofactor of 150 for flow cytometry
train[, useMarkers] <- cyCombine::transform_asinh(train[, useMarkers], 
                                                  markers = useMarkers,
                                               cofactor = 5)

test[, useMarkers] <- cyCombine::transform_asinh(test[, useMarkers], 
                                                  markers = useMarkers,
                                               cofactor = 5)

preProcValues <- preProcess(train[, useMarkers], method = c("range"))
# 
train[, useMarkers] <- predict(preProcValues, train[, useMarkers])
test[, useMarkers] <- predict(preProcValues, test[, useMarkers])
```

# train on train data
## get the reference sample
```{r}
res_ind <- ComputeReferenceSample(df, useMarkers, N = 2)
```
## Normalise training data
```{r}
train_dat <- train[which(train$sample_id == res_ind$topNSamples), ]
encoding_dim <- FuseSOM::computeGridSize(train_dat[, useMarkers])
```

```{r}
cov_mat <- Rfast::cova(train_dat[, useMarkers] %>% as.matrix())
ED = estimate.ED(x = cov_mat, length(unique(df$file_name)), cov.mat = T, round.digits = 0)
```

```{r}
batch_size = 32L
# sizes <- c(14, 12, 11)
vae_model <- train_vae_model(train_dat = train_dat[, useMarkers], batch_size = batch_size,
                             useMarkers = useMarkers, epochs = 100, lambda = 0.1)
```

```{r}
train_decoded <- decode_samples(new_samples = as.matrix(train[, useMarkers]), 
                                vae = vae_model$vae,
                                batch_size = batch_size)
df_norm <- train_decoded[[1]]

train_encoded <- train_decoded$encoded %>%
  as.matrix() %>%
  as.data.frame()

colnames(df_norm) <- useMarkers
```

```{r}
test_decoded <- decode_samples(new_samples = as.matrix(test[, useMarkers]), 
                               vae = vae_model$vae, 
                               batch_size = batch_size)
df_norm_test <- test_decoded[[1]]

test_encoded <- test_decoded$encoded %>%
  as.matrix() %>%
  as.data.frame()

colnames(df_norm_test) <- useMarkers
```

## create sce object for training data
```{r}
sce_norm <- SingleCellExperiment(assays = list(norm = t(df_norm[, useMarkers]),
                                               raw = t(train[, useMarkers])
),
colData = train[, 1:4])
reducedDims(sce_norm) <- list(VAE=train_decoded$encoded %>%
                                as.matrix() %>%
                                as.data.frame())
```

```{r}
sce_norm_test <- SingleCellExperiment(assays = list(norm = t(df_norm_test[, useMarkers]),
                                                    raw = t(test[, useMarkers])
),
colData = test[, 1:4])
reducedDims(sce_norm_test) <- list(VAE=test_decoded$encoded %>%
                                as.matrix() %>%
                                as.data.frame())
```

## cluster training data
```{r}
# run FuseSOM clustering
nclust = 11
sce_norm <- runFuseSOM(sce_norm, numClusters = nclust, assay = 'norm',
                       verbose = F)
```


## Get a umap plot of the data
```{r, eval=F}
set.seed(1994)
sce_norm_sub <- sce_norm[, sample(nrow(df_norm), 100000)]

sce_norm_sub <- scater::runUMAP(sce_norm_sub,
                         subset_row = colnames(df_norm),
                         exprs_values = "norm",
                         BPPARAM = BPPARAM,
                         n_threads = 7,
                         metric = 'euclidean',
                         verbose = T)

nb.cols <- 20
# mycolors <- colorRampPalette(pal_d3())(nb.cols)
# mycolors_new <- paletteer_d("ggsci::category20b_d3")

df_umap <- reducedDim(sce_norm_sub, 'UMAP') %>%
    as.data.frame()
colnames(df_umap) <- c('UMAP 1', 'UMAP 2')

df_umap$`Cell Type` <- sce_norm_sub$clusters

df_umap %>% ggplot(aes(`UMAP 1`, `UMAP 2`)) +
    geom_point(aes(color = `Cell Type`), size = 1) + 
    ggtitle('Umap plot of cells') +
  theme_bw() +
    theme(axis.text.x = element_text(size = 12),
        plot.title = element_text(size = 15, hjust = 0.5),
        axis.text.y = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12)
        ) + scale_color_d3(palette = 'category20')
```

```{r}
scater::plotGroupedHeatmap(sce_norm, 
                           features = colnames(df_norm), 
                           group = "clusters", 
                           block = "clusters",
                           exprs_values = "norm",
                           center = TRUE, 
                           scale = TRUE, 
                           zlim = c(-2,2),
                           cluster_rows = FALSE)
```

# Train cell type identification model
## Set up training and testing data
```{r}
x_train <- reducedDim(sce_norm, "VAE") %>%
  # t() %>%
  as.data.frame() %>%
  # mutate(sample_id = sce_norm$sample_id) %>%
  mutate(cellTypes = factor(sce_norm$clusters)) %>%
  # dplyr::filter(sample_id %in% res_ind$topNSamples) %>%
  # dplyr::select(-sample_id) %>%
  mutate(cellTypes = droplevels(cellTypes))

x_test <- reducedDim(sce_norm_test, "VAE") %>%
  # t() %>%
  as.data.frame()
```

## Predict cell types using SVM with a linear kernel
```{r}
test_clusters <- cellTypeClassifier(train_x = x_train, test_x = x_test, model = 'lda')
table(test_clusters)
sce_norm_test$clusters <- test_clusters
```




```{r}
# do prediction
data <- getProp(sce_norm,
                feature = "clusters", imageID = "sample_id", logit = F) %>%
  na.omit()


data <- 2*asin(sqrt(data))
# 
# data_2 <- getProp(sce_norm,
#                   feature = "clusters", imageID = "sample_id", logit = T) %>%
#   na.omit()
# data <- cbind(data, data_2)
colnames(data) <- janitor::make_clean_names(colnames(data))

clinicaldata <- colData(sce_norm) %>%
  as.data.frame() %>%
  dplyr::select(sample_id, condition) %>%
  distinct()
clinicaldata$sample_id <- as.character(clinicaldata$sample_id)

clinicaldata$condition <- factor(if_else(clinicaldata$condition == "COVID", 1, 0))

condition <- clinicaldata$condition

data_logit <- getProp(sce_norm,
                feature = "clusters", imageID = "sample_id", logit = T) %>%
  na.omit()

data_logit <- data_logit[rownames(data_logit) %in% clinicaldata$sample_id, ]

colnames(data_logit) <- paste0(colnames(data_logit), "_logit")
colnames(data) <- paste0(colnames(data), "_prop")
```


# Marker mean per cell type
```{r}
coldat <- colData(sce_norm) %>%
  as.data.frame()

# Protein mean per cell type
markerDf = 
  coldat |> 
  dplyr::select(sample_id, clusters) |> 
  cbind(data.frame(t(assay(sce_norm, "norm")))) |>
  dplyr::select(sample_id, clusters,useMarkers) 

# Mean marker per cell type
markerMeanCellType = markerDf |> 
  group_by(sample_id, clusters) |> 
  summarise_at(vars(-group_cols()), mean, na.rm = TRUE) |> 
  pivot_longer(-c(sample_id, clusters), names_to = "markers") |> 
  pivot_wider(names_from = c(clusters, markers), values_from = value) |> 
  column_to_rownames("sample_id") %>% 
  replace(is.na(.), 0)
```

# Test set
```{r}
# do prediction
data_test <- getProp(sce_norm_test,
                feature = "clusters", imageID = "sample_id", logit = F) %>%
  na.omit()


data_test <- 2*asin(sqrt(data_test))
# 
# data_2 <- getProp(sce_norm,
#                   feature = "clusters", imageID = "sample_id", logit = T) %>%
#   na.omit()
# data <- cbind(data, data_2)
colnames(data_test) <- janitor::make_clean_names(colnames(data_test))

clinicaldata_test <- colData(sce_norm_test) %>%
  as.data.frame() %>%
  dplyr::select(sample_id, condition) %>%
  distinct()
clinicaldata_test$sample_id <- as.character(clinicaldata_test$sample_id)

clinicaldata_test$condition <- factor(if_else(clinicaldata_test$condition == "COVID", 1, 0))

condition_test <- clinicaldata_test$condition

data_test_logit <- getProp(sce_norm_test,
                feature = "clusters", imageID = "sample_id", logit = T) %>%
  na.omit()

data_test_logit <- data_test_logit[rownames(data_test_logit) %in% clinicaldata_test$sample_id, ]

colnames(data_test_logit) <- paste0(colnames(data_test_logit), "_logit")
colnames(data_test) <- paste0(colnames(data_test), "_prop")
```


# Marker mean per cell type
```{r}
coldat_test <- colData(sce_norm_test) %>%
  as.data.frame()

# Protein mean per cell type
markerDf_test = 
  coldat_test |> 
  dplyr::select(sample_id, clusters) |> 
  cbind(data.frame(t(assay(sce_norm_test, "norm")))) |>
  dplyr::select(sample_id, clusters,useMarkers) 

# Mean marker per cell type
markerMeanCellType_test = markerDf_test |> 
  group_by(sample_id, clusters) |> 
  summarise_at(vars(-group_cols()), mean, na.rm = TRUE) |> 
  pivot_longer(-c(sample_id, clusters), names_to = "markers") |> 
  pivot_wider(names_from = c(clusters, markers), values_from = value) |> 
  column_to_rownames("sample_id") %>% 
  replace(is.na(.), 0)
```


```{r}
d_logit <- coop::pcor(data_logit) %>%
  cor2dist() %>%
  as.dist()
hc_logit <- hclust(d_logit, method = 'ward')
# Extract clusters from the dendrogram
hc_logit <- treekoR:::findChildren(ggtree(as.phylo(hc_logit),
                                            ladderize = F, layout = 'dendrogram'))
# Extract clusters and assign group numbers
subs_logit <- hc_logit$data$clusters
logit_dat <- hc_logit$data
logit_dat$group <- 1:length(subs_logit)
```

```{r}
nclust <- ncol(data)
# Prepare variable groups for overlapping group Lasso
var_groups<- list()
n <- length(subs_logit)
# n2 <- 2*n
for(i in 1:length(subs_logit)){
    var_groups[[i]] <- which(make_clean_names(colnames(data_logit)) %in% 
                               make_clean_names(subs_logit[[i]]))
    # var_groups[[i+n]] <- which(make_clean_names(colnames(data_logit)) %in% 
    #                              make_clean_names(subs_logit[[i]])) + nclust
  }
  
```

```{r}
celltypes <- unique(df_norm$clusters_fs)
celltypes <- celltypes[celltypes != ""]
celltypes <- celltypes[celltypes != "other"]
last_max <- nclust
off_set <- length(var_groups)
for (i in 1:ncol(markerMeanCellType)) {
  index <- off_set + i  # Calculate the new index in the list
  begin <- last_max + 1        # Start the next sequence right after the last max
  end <- begin      # Each sublist has exactly 27 items

  # Add the new sequence to the res list at the new index
  var_groups[[index]] <- seq(begin, end)

  # Update last_max for the next iteration
  last_max <- end
}

# var_groups[off_set + 1] <- list(seq(last_max + 1, ncol(markerMeanCellType) + last_max))
```

```{r}
# Combine all input data matrices
X_train <- cbind(data_logit, markerMeanCellType) 
# colnames(X_train) <- janitor::make_clean_names(colnames(X_train))
  
  # Scale the combined data
scaleVals <- preProcess(X_train, method = c('center', 'scale'))
X_train <- predict(scaleVals, X_train) %>%
    as.matrix()
# X_train[, 1:nclust] <- X_train[, 1:nclust]/nclust
# X_train[, (nclust+1):ncol(markerMeanCellType)] <- X_train[, (nclust+1):ncol(markerMeanCellType)]/(nclust*length(markerMeanCellType))
  
  # Extract response variable
y_train <- condition %>%
    as.numeric()
```

```{r, eval=T}
alpha_search = seq(0.01, 0.1, 0.01)
res_aic <- selectApha(X_train, y_train, alpha_search = alpha_search,
                      groups = var_groups, penalty = 'cMCP')
```

```{r}
alpha <- alpha_search[computeElbow(res_aic$aics)]
cvfit <- cv.grpregOverlap(X_train, y_train, var_groups, penalty = 'cMCP',
                            family = 'binomial',  alpha = alpha, nfolds = 10,
                            seed = 999)
# Plot cross-validation results
par(mfrow=c(2,2))
plot(cvfit, type = "all")

# Fit overlapping group Lasso model
fit <- grpregOverlap(X_train, y_train, var_groups,
                       family='binomial', alpha = alpha,
                       returnX.latent = T, returnOverlap = FALSE,
                       lambda = cvfit$lambda.min, penalty = 'cMCP')

# fit <- res_aic$best_fit
```

```{r}
X_test <- cbind(data_test_logit, markerMeanCellType_test) %>%
  as.matrix()
# colnames(X_test_study_3) <- janitor::make_clean_names(colnames(X_test_study_3))
X_test <- predict(scaleVals, X_test)
# X_test_study_3[, 1:nclust] <- X_test_study_3[, 1:nclust]/nclust
# X_test_study_3[, (nclust+1):ncol(markerMeanCellType)] <- X_test_study_3[, (nclust+1):ncol(markerMeanCellType)]/(nclust*length(markerMeanCellType))
```

## Predict on test data
```{r}
pred_test <- predict(fit, X = X_test,
                        type = "response")

write.csv(as.data.frame(pred_test),
          '../data/Covid_Bcell_glasso_aucs.csv')

pred_test_vals <- prediction(pred_test, condition_test)
pred_test_perf <- ROCR::performance(pred_test_vals, "tpr", "fpr")


plt_dat_test = data.frame(
  FPR = pred_test_perf@x.values[[1]],
  TPR = pred_test_perf@y.values[[1]]
)

auc_test <- ROCR::performance(pred_test_vals, measure = "auc")
auc_test <- auc_test@y.values[[1]]
```

```{r}
# Generate AUC plot
ggplot(plt_dat_test, aes(x = FPR, y = TPR)) +
  geom_line(colour = "blue") +
  labs(x = pred_test_perf@x.name, y = pred_test_perf@y.name) +
  geom_abline(slope = 1, intercept = 0) + theme_bw() +
  theme(
    plot.title = element_text(color="Black", size=16, face="bold", hjust = 0.5),
    plot.subtitle = element_text(color = "red", size = 16, hjust = 0.5),
    axis.title.x = element_text(color="Black", size=16),
    axis.title.y = element_text(color="Black", size=16),
    axis.text.y = element_text(size = 16),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 16),
    strip.text.x = element_text(size = 16),
    legend.title = element_text(size=16), #change legend title font size
    legend.text = element_text(size=16) #change legend text font size)
  )  + ggtitle(paste("Overlap Group Lasso - AUC =", round(auc_test, 2)))
```


# Plot overlap tree
```{r}
visualiseModelTree(fit = fit, tree = hc_logit, type = "cluster", 
                   training_data = X_train)
```

# Fit a baseline Lasso model
```{r}
set.seed(999)
cv.lasso <- cv.glmnet(X_train, condition, family='binomial', alpha=1, parallel=TRUE, 
                      standardize=F, relax = F, type.measure = 'auc',nfolds = 10)
plot(cv.lasso)
coef(cv.lasso, s='lambda.min')
coef <- coef(cv.lasso, s='lambda.min')
selected_attributes <- (coef@i[-1]+1)

```

```{r}
pred_test <- predict(cv.lasso, newx = X_test, 
                     type = "response", s = 'lambda.min')

write.csv(as.data.frame(pred_test),
          '../data/breast_cancer_baseline_aucs.csv')


pred_fs <- prediction(pred_test, condition_test)
perf_fs <- ROCR::performance(pred_fs, "tpr", "fpr")


plt_dat = data.frame(
  FPR = perf_fs@x.values[[1]],
  TPR = perf_fs@y.values[[1]]
)

auc_perf <- ROCR::performance(pred_fs, measure = "auc")
auc <- auc_perf@y.values[[1]]

# generate AUC plot
p_auc <- ggplot(plt_dat, aes(x = FPR, y = TPR)) +
  geom_line(colour = "blue") +
  labs(x = perf_fs@x.name, y = perf_fs@y.name) +
  geom_abline(slope = 1, intercept = 0) + theme_bw() +
  theme(
    plot.title = element_text(color="Black", size=16, face="bold", hjust = 0.5),
    plot.subtitle = element_text(color = "red", size = 16, hjust = 0.5),
    axis.title.x = element_text(color="Black", size=16),
    axis.title.y = element_text(color="Black", size=16),
    axis.text.y = element_text(size = 16),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 16),
    strip.text.x = element_text(size = 16),
    legend.title = element_text(size=16), #change legend title font size
    legend.text = element_text(size=16) #change legend text font size)
  )  + ggtitle(paste("Test Set - AUC =", round(auc, 2)))

p_auc
```


# Save SCE objects
```{r, eval=T}
save(sce_norm, file = "../data/bcell_down_sampled_train_MMD_VAE_sce.RData")
save(sce_norm_test, file = "../data/bcell_down_sampled_test_MMD_VAE_sce.RData")
```

# Write the FCS files for other methods
```{r, eval=FALSE}
files <- metadata$file_name
file_names <- c()


for(i in 1:length(files)){
  cur_sample <- files[[i]]
  print(cur_sample)
  dta <- df[df$file_name == cur_sample, useMarkers] %>%
    as.matrix()
  dimnames(dta)[[2]] <- colnames(dta)
  
  meta <- data.frame(name=dimnames(dta)[[2]],
                     desc=dimnames(dta)[[2]])
  
  meta$range <- apply(apply(dta[, useMarkers],2,range),2,diff)
  meta$minRange <- apply(dta,2,min)
  meta$maxRange <- apply(dta,2,max)
  
  ff <- new("flowFrame",
            exprs=dta,
            parameters=AnnotatedDataFrame(meta)
  )
  
  dir <- '/home/ewillie/Documents/PhD/DeepLearning_CyTOF/COVID_19_PBMC_Mathew_2020/data/data_sub_10k/'
  name <- files[i]
  file_name <- paste0(dir,name)

  write.FCS(ff,filename = file_name)

  file_names <- c(file_names, name)
}
```